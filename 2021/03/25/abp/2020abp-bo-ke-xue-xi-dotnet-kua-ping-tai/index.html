<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="初识ABP vNext, IT 学习 资源站 C# CAD .net core EF Javascript Flutter TypeScript 数据结构 算法 网络 测试 产品">
    <meta name="description" content="IT 学习 资源站 C# CAD .net core EF Javascript Flutter TypeScript 数据结构 算法 网络 测试 产品">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>初识ABP vNext | IT 学习 资源</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="IT 学习 资源" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">IT 学习 资源</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">IT 学习 资源</div>
        <div class="logo-desc">
            
            IT 学习 资源站 C# CAD .net core EF Javascript Flutter TypeScript 数据结构 算法 网络 测试 产品
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/jiayueshe/jiayueshe.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/jiayueshe/jiayueshe.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/7.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">初识ABP vNext</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="container content">

    
    <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/abp/">
                                <span class="chip bg-color">abp</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/abp/" class="post-category">
                                abp
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-03-25
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-03-25
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    9.3k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    38 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="初识ABP-vNext（1）：开篇计划-amp-基础知识"><a href="#初识ABP-vNext（1）：开篇计划-amp-基础知识" class="headerlink" title="初识ABP vNext（1）：开篇计划&amp;基础知识"></a>初识ABP vNext（1）：开篇计划&amp;基础知识</h2><p><img src="https://csdnimg.cn/release/blogv2/dist/pc/img/reprint.png" alt="img"></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSnNYaWFZWjYya0Yya0VOZFVIMlY3QkRFZnFIMHJoeGxPOUZmMFlzSFlmUDhpYzhRUWdRUnV6bGljMjJta1VrSzZjN2RHT3AwcnNUR2NVUS82NDA?x-oss-process=image/format,png" alt="img"></p>
<ul>
<li>审计(Audit)</li>
<li>本地化(Localization)</li>
<li>事件总线(Event Bus)</li>
<li>多租户(multi-tenancy technology)</li>
<li>DDD分层</li>
<li>实体(Entity)</li>
<li>值对象(Value Object)</li>
<li>聚合根(Aggregate Root)</li>
<li>仓储(Repository)</li>
<li>应用服务(Application Services)</li>
<li>数据传输对象(DTO)</li>
<li>工作单元(Unit Of Work)</li>
</ul>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>ABP vNext（以下简称ABP）的前身是asp.net boilerplate（老版abp），它不是一个简单的版本更新，而是完全基于.NET Core的重写。之前有听说过ABP框架，但是一直没有去详细了解。最近认真学习了一下，准备记录下自己的一些心得，计划分为3部分来进行：</p>
<ol>
<li>ABP基础（就是官网上一些基本的功能）</li>
<li>ABP实战（使用ABP+vue开发一个简单项目）</li>
<li>ABP模块化（微服务简单介绍）</li>
</ol>
<p>首先，这是以一个0基础的视角去写的，所以会比较基础，适合新手。文中如果有不对的地方，大家可以帮我指出来相互学习。。。</p>
<h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><p>ABP官网：<a target="_blank" rel="noopener" href="https://www.abp.io/">https://www.abp.io/</a></p>
<p>ABP GitHub：<a href="https://github.com/abpframework/abp">https://github.com/abpframework/abp</a></p>
<p>要学习ABP，首先肯定要认真看一下官方的文档，虽然目前官方文档还不完整；然后对哪一部分不理解的，可以适当的阅读一下源码。</p>
<p>ABP是基于DDD:Domain-Driven Design（领域驱动设计）去开发的，当然框架本身不强制你使用DDD，但是他建议把DDD作为最佳实践。如果了解DDD，并且使用过老版本abp的话，看官方文档可能就比较轻松，反之则会比较吃力。。。首先DDD理论就非常抽象和复杂，要深刻理解它并不容易；其次是ABP内部使用了很多开源组件，比如EF Core，IdentityServer4，Autofac，AutoMapper，Swagger等等，所以也需要对这些组件有所了解。</p>
<p>本篇简单介绍一下ABP官方文档上一些重要的关键字，先理解这些关键字，才能更好的进一步学习。</p>
<h3 id="审计-Audit"><a href="#审计-Audit" class="headerlink" title="审计(Audit)"></a>审计(Audit)</h3><p>审计是用于追踪数据变化的过程。平时开发中，你一定经常见到类似创建时间、创建人、修改时间、修改人等属性，这些属性就是用于数据审计。ABP框架提供了一些接口和基类来标准化这些属性，并自动设置它们的值；并且ABP提供了一个可扩展的审计日志系统，自动化的根据约定记录审计日志，并提供配置来控制审计日志的级别。ABP中审计相关基类/接口有：<code>IAuditedObject</code>、<code>AuditedEntity</code>、<code>AuditedAggregateRoot</code>等等。</p>
<h3 id="本地化-Localization"><a href="#本地化-Localization" class="headerlink" title="本地化(Localization)"></a>本地化(Localization)</h3><p>使应用程序支持多国语言。ABP的本地化系统与ASP.NET Core的本地化兼容。</p>
<h3 id="事件总线-Event-Bus"><a href="#事件总线-Event-Bus" class="headerlink" title="事件总线(Event Bus)"></a>事件总线(Event Bus)</h3><blockquote>
<p>事件总线是对观察者（发布-订阅）模式的一种实现。它是一种集中式事件处理机制，允许不同的组件之间进行彼此通信而又不需要相互依赖，达到一种解耦的目的。</p>
</blockquote>
<p>如果没有接触过Event Bus，可能不太好理解。一个不太恰当的例子：A需要租房，B需要把房子租出去，A想直接找到B是比较困难的，A也不想去认识B，所以才有房产中介C，C就是Event Bus；B提前跟C说我的房子需要出租，A跟C说我给你钱你帮我租一个房，那么C很容易就帮A找到B完成租房，A甚至不需要知道B是谁，这里A就是事件的发布者，B是事件的订阅者。ABP支持本地Event Bus和分布式Event Bus。</p>
<h3 id="多租户-multi-tenancy-technology"><a href="#多租户-multi-tenancy-technology" class="headerlink" title="多租户(multi-tenancy technology)"></a>多租户(multi-tenancy technology)</h3><p>多租户是一种软件架构技术，这种架构可以让多个租户共用相同的系统，并且可以确保各租户间数据的隔离性。相信很多人都遇到过类似需求，同一个系统中根据不同客户区分数据；通常我们会在数据库表中增加一个客户Id作为标识，或者根据不同客户读取不同的数据库，这都是多租户数据隔离的实现方式，想自己很好的实现多租户还是很繁琐的。ABP的多租户模块提供了创建多租户应用程序的基本功能，可以很轻松的帮你实现多租户。</p>
<h3 id="DDD分层"><a href="#DDD分层" class="headerlink" title="DDD分层"></a>DDD分层</h3><ul>
<li><strong>表示层</strong>: 为用户提供接口，使用应用层实现与用户交互。</li>
<li><strong>应用层</strong>: 表示层与领域层的中介，编排业务对象执行特定的应用程序任务，使用应用程序逻辑实现用例。</li>
<li><strong>领域层</strong>: 包含业务对象以及业务规则，是应用程序的核心。</li>
<li><strong>基础设施层</strong>: 提供通用的技术功能，支持更高的层，主要使用第三方类库。</li>
</ul>
<h3 id="实体-Entity"><a href="#实体-Entity" class="headerlink" title="实体(Entity)"></a>实体(Entity)</h3><blockquote>
<p>一个没有从其属性，而是通过连续性和身份的线索来定义的对象。</p>
</blockquote>
<p>官方文档中这句话非常难理解。。。</p>
<p>简单来说，当一个对象只能由他的标识（Id）来区分，而不是从其他属性来区分时，这种对象被称为实体。比如有很多叫“张三”的男人，你不能通过姓名和性别来区分到底是哪个张三，只能通过Id。实体是可以持续变化的，我们可以对实体进行多次修改，但是无论怎么修改，实体始终拥有它唯一的标识。DDD中的实体通常都是充血模型，充血模型就是实体中不光有属性，还会包含行为（方法），反之DTO，ViewModel就是典型的贫血模型。实体通常映射到关系型数据库的表中，ABP中实体相关的基类/接口有：<code>Entity</code>、<code>IEntity</code>、<code>AuditedEntity</code>等等。</p>
<h3 id="值对象-Value-Object"><a href="#值对象-Value-Object" class="headerlink" title="值对象(Value Object)"></a>值对象(Value Object)</h3><p>值对象和实体恰好相反，它不需要唯一标识，并且它不可以被改变。值对象通常是用来度量和描述事物，当你只关注某个对象的属性时，该对象便可以是一个值对象。比如“北京”就是“北京”，不存在Id=1或者Id=2的北京的说法。当然，值对象虽然不存在唯一标识，但是不代表它在数据库中就没有Id主键。。。</p>
<h3 id="聚合根-Aggregate-Root"><a href="#聚合根-Aggregate-Root" class="headerlink" title="聚合根(Aggregate Root)"></a>聚合根(Aggregate Root)</h3><p>聚合是业务逻辑紧密关联的实体和值对象组合而成，聚合是数据修改和持久化的基本单元，聚合后产生的根实体称为聚合根。若一个聚合仅有一个实体，那这个实体就是聚合根。聚合根被视为一个单元，你不能单独去修改聚合根中的子实体。例如，某个业务流程中，会操作A、B、C、D四个对象（简单理解为数据库表），那么将ABCD聚合，产生一个聚合根E，对外部来说只需要操作E就可以了，领域内部会处理好ABCD。这样一方面避免了多个对象的混乱，另一方面也保证了数据的完整性，不会出现AB操作成功了，CD操作失败了，导致数据库产生脏数据。</p>
<p>聚合根引用聚合根：通过ID。</p>
<p>聚合根引用实体：通过对象（导航属性）。</p>
<p>聚合根引用值对象：通过对象（导航属性）。</p>
<h3 id="仓储-Repository"><a href="#仓储-Repository" class="headerlink" title="仓储(Repository)"></a>仓储(Repository)</h3><p>仓储用于操作领域对象（实际就是操作数据库），通常会为每个聚合根或不同的实体创建对应的仓储。ABP也提供了通用的泛型仓储：<code>IRepository&lt;TEntity, TKey&gt;</code>，内置了增删改查基本功能，直接注入就可以使用。</p>
<h3 id="应用服务-Application-Services"><a href="#应用服务-Application-Services" class="headerlink" title="应用服务(Application Services)"></a>应用服务(Application Services)</h3><p>应用层处于展示层与领域层之间，展示层通常调用应用服务，应用服务调用领域然后返回数据给展示层。展示层也可以直接调用领域。APB中应用服务相关的基类/接口有：<code>IApplicationService</code>、<code>ApplicationService</code>、<code>ICrudAppService</code>、<code>CrudAppService</code>等等。</p>
<h3 id="数据传输对象-DTO"><a href="#数据传输对象-DTO" class="headerlink" title="数据传输对象(DTO)"></a>数据传输对象(DTO)</h3><p>通常领域对象不适合直接在应用层与展示层之间传递，比如User中的Passwod字段，这时候就需要用到DTO，DTO和ViewModel类似。ABP提供了一些DTO基类/接口：<code>IEntityDto</code>、<code>EntityDto</code>、<code>AuditedEntityDto</code>等等。</p>
<h3 id="工作单元-Unit-Of-Work"><a href="#工作单元-Unit-Of-Work" class="headerlink" title="工作单元(Unit Of Work)"></a>工作单元(Unit Of Work)</h3><p>UOW模式是为了保证一次业务操作的数据完整性。ABP框架的UOW实现提供了对应用程序中的数据库连接和事务范围的抽象和控制，使用ABP的话通常你不用自己去写数据库事务相关代码。实际上工作单元不一定非要创建数据库事务，比如HTTP GET请求就不会启动事务性UOW，它们仍然启动UOW，但不创建数据库事务。这一切都由ABP框架自动完成。</p>
<h2 id="初识ABP-vNext（2）：ABP启动模板"><a href="#初识ABP-vNext（2）：ABP启动模板" class="headerlink" title="初识ABP vNext（2）：ABP启动模板"></a>初识ABP vNext（2）：ABP启动模板</h2><ul>
<li>AbpHelper</li>
<li>模块安装</li>
</ul>
<h3 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h3><p>上一篇介绍了ABP的一些基础知识，本篇继续介绍ABP的启动模板。使用ABP CLI命令就可以得到这个启动模板，其中包含了一些基础功能模块，你可以基于这个模板来快速开发。</p>
<h3 id="开始-1"><a href="#开始-1" class="headerlink" title="开始"></a>开始</h3><p>首先ABP CLI的安装以及基本指令这些就不说了，官网上写的很清楚。目前ABP的前端部分只支持ASP.NET Core MVC / Razor Pages和Angular，移动端支持React Native。</p>
<p>初学者建议跟着官网<a target="_blank" rel="noopener" href="https://docs.abp.io/zh-Hans/abp/latest/Tutorials/Part-1?UI=MVC%E8%BF%99%E4%B8%AA%E6%8C%87%E5%BC%95%E5%81%9A%E4%B8%80%E9%81%8D%EF%BC%8C%E4%BD%93%E9%AA%8C%E4%B8%80%E4%B8%8BABP%E5%BC%80%E5%8F%91%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B%EF%BC%8C%E8%99%BD%E7%84%B6ABP%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B%E5%87%A0%E4%B9%8E%E9%83%BD%E6%A0%87%E5%87%86%E5%8C%96%E4%BA%86%EF%BC%8C%E7%85%A7%E7%9D%80%E5%AE%98%E7%BD%91%E7%9A%84%E6%B5%81%E7%A8%8B%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81%E5%B0%B1%E8%83%BD%E5%AE%8C%E6%88%90%E4%B8%80%E4%B8%AA%E5%8A%9F%E8%83%BD%E7%9A%84%E5%BC%80%E5%8F%91%EF%BC%8C%E4%BD%86%E6%98%AF%E8%BF%99%E4%B8%AA%E8%BF%87%E7%A8%8B%E6%9C%89%E4%BA%9B%E7%B9%81%E7%90%90%EF%BC%8C%E5%AE%B9%E6%98%93%E5%87%BA%E9%94%99%E3%80%82%E8%BF%99%E9%87%8C%E6%8E%A8%E8%8D%90%E4%B8%80%E4%B8%AA%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%EF%BC%9Ahttps://github.com/EasyAbp/AbpHelper.GUI%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AAABP%E5%B8%AE%E5%8A%A9%E5%B7%A5%E5%85%B7%EF%BC%8C%E4%BD%A0%E5%8F%AA%E9%9C%80%E8%A6%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BD%93%EF%BC%8C%E5%89%A9%E4%B8%8B%E7%9A%84%E4%BB%A3%E7%A0%81%E5%AE%83%E9%83%BD%E5%8F%AF%E4%BB%A5%E5%B8%AE%E4%BD%A0%E7%94%9F%E6%88%90%E3%80%82%E8%BF%99%E4%B8%AA%E9%A1%B9%E7%9B%AE%E6%98%AFhttps://github.com/EasyAbp%E4%B8%8B%E7%9A%84%E4%B8%80%E4%B8%AA%E5%AD%90%E9%A1%B9%E7%9B%AE%EF%BC%8CEasyAbp%E6%98%AF%E5%9B%BD%E5%86%85ABP%E7%88%B1%E5%A5%BD%E8%80%85%E5%88%9B%E5%BB%BA%E7%9A%84%EF%BC%8C%E9%87%8C%E9%9D%A2%E8%BF%98%E6%9C%89%E5%BE%88%E5%A4%9A%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8%E7%9A%84%E6%A8%A1%E5%9D%97%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%85%B3%E6%B3%A8%E4%B8%80%E4%B8%8B%E3%80%82%E3%80%82%E3%80%82">https://docs.abp.io/zh-Hans/abp/latest/Tutorials/Part-1?UI=MVC这个指引做一遍，体验一下ABP开发的基本流程，虽然ABP开发流程几乎都标准化了，照着官网的流程编写代码就能完成一个功能的开发，但是这个过程有些繁琐，容易出错。这里推荐一个开源项目：https://github.com/EasyAbp/AbpHelper.GUI，这是一个ABP帮助工具，你只需要创建一个实体，剩下的代码它都可以帮你生成。这个项目是https://github.com/EasyAbp下的一个子项目，EasyAbp是国内ABP爱好者创建的，里面还有很多开箱即用的模块，可以关注一下。。。</a></p>
<h3 id="AbpHelper"><a href="#AbpHelper" class="headerlink" title="AbpHelper"></a>AbpHelper</h3><p>使用AbpHelper来完成官网的例子非常容易，首先创建项目解决方案：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNodWFmSDBBY0pwWEh6ZGxWTE5wSmJKU2ZYSG5qRGRLY1lnRWF2RDNYMENyYXZtT25Kc0xVOFEvNjQw?x-oss-process=image/format,png" alt="img"> <img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNVVEJMblpoOFdHaFpBYlBlQ0IxbmY4U1R0ZmFvMTFqaWNUOHlLdnIyaFY2UnpyNGUyQXJuVG1BLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>AbpHelper提供了图形化配置，自动帮我们执行ABP CLI指令：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNvYUZ3ZVdOdnNJeDlReXdwcFNlN1lURzY2dXpuOEthMkZUaWEzalpsYTAxdFliUTJPdTNHckpRLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>执行完成后，打开解决方案，先启动Acme.BookStore.DbMigrator项目来初始化数据库：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNLWW01UUVkUFJlTng0QmhHZ3VqeFY3N2p1ZDJYdlBwM0hwa2I3U1ZhUEZhaWFUZ0tpYUdqRm5ady82NDA?x-oss-process=image/format,png" alt="img"> <img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNDbVJ6Z1NCaGZESDMzWVZaYWRXeVBYajVSdmRhMGZhMWFHaWMyc2F3U01BeE1JMlpXSkNpYmlhb2cvNjQw?x-oss-process=image/format,png" alt="img"> <img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWM4TUVCbnN1NlZHUGVHR2liZDJUejB2SXVLcHIwRDl2b1pNendmN05rWHczWUJKTDJzaEJqR1d3LzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>然后就可以启动Acme.BookStore.Web项目，这是APB启动模板的默认界面：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNFWUZJVFVrYTRRWENZR1hncGdTZW9YSWpJNW1rOVpmWlZjSVZRWWRsZjN6eXJkS1ppY3VqOFBBLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>接下来，在Acme.BookStore.Domain项目中创建Book实体，我直接从官网上复制代码。</p>
<pre class=" language-go"><code class="language-go">public class Book <span class="token punctuation">:</span> AuditedAggregateRoot<span class="token operator">&lt;</span>Guid<span class="token operator">></span>



<span class="token punctuation">{</span>



    public <span class="token builtin">string</span> Name <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span>



 



    public BookType Type <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span>



 



    public DateTime PublishDate <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span>



 



    public float Price <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span>



 



    protected <span class="token function">Book</span><span class="token punctuation">(</span><span class="token punctuation">)</span>



    <span class="token punctuation">{</span>



    <span class="token punctuation">}</span>



    public <span class="token function">Book</span><span class="token punctuation">(</span>Guid id<span class="token punctuation">,</span> <span class="token builtin">string</span> name<span class="token punctuation">,</span> BookType <span class="token keyword">type</span><span class="token punctuation">,</span> DateTime publishDate<span class="token punctuation">,</span> float price<span class="token punctuation">)</span>



        <span class="token punctuation">:</span> <span class="token function">base</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>



    <span class="token punctuation">{</span>



        Name <span class="token operator">=</span> name<span class="token punctuation">;</span>



        Type <span class="token operator">=</span> <span class="token keyword">type</span><span class="token punctuation">;</span>



        PublishDate <span class="token operator">=</span> publishDate<span class="token punctuation">;</span>



        Price <span class="token operator">=</span> price<span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



<span class="token punctuation">}</span>
</code></pre>
<p>在Acme.BookStore.Domain.Shared项目中添加枚举类BookType：</p>
<pre class=" language-go"><code class="language-go">public enum BookType



<span class="token punctuation">{</span>



    Undefined<span class="token punctuation">,</span>



    Adventure<span class="token punctuation">,</span>



    Biography<span class="token punctuation">,</span>



    Dystopia<span class="token punctuation">,</span>



    Fantastic<span class="token punctuation">,</span>



    Horror<span class="token punctuation">,</span>



    Science<span class="token punctuation">,</span>



    ScienceFiction<span class="token punctuation">,</span>



    Poetry



<span class="token punctuation">}</span>
</code></pre>
<p>第一次使用需要安装一下AbpHelper CLI：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWMzaG1LNVVzSFAwekRmd3l4VzkwMEpuRFJUYVhIM21Ua2Z1YTRibWtxMmxjWGRqSDBnNTI4WHcvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p>选择Generate CRUD，填入实体名称和解决方案路径，然后Execute即可：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNXMWljVGQ2ZlI0RGxFeDdJVFlLaWFlaWF3Y3ZDR2V2WkdaN3VoUkJ0UDVlWWF2amFHak1XMEpKV2cvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p>生成代码时可能会报这个错（如果没装ef tools）：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNYdEVjYmc5TDNJSDc0TlFxOGt6RlA1bU84RVB2a2VMUlV6OW9mUXRIcUJ3NWliUkNrSGliZGhtZy82NDA?x-oss-process=image/format,png" alt="img"></p>
<p>这时安装一下ef tools就好了，<code>dotnet tool install -g dotnet-ef</code></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNQS0dpYkppY2p0Mzl2R293cmZ2d2FpYTR1eWlhZGZQNDQ3U20yVk1tRDE3U3ZINW1WQTVBaWJacW9IQS82NDA?x-oss-process=image/format,png" alt="img"></p>
<p>代码生成完后，运行Acme.BookStore.Web项目：</p>
<p>使用默认用户 admin/1q2w3E* 登录系统，给admin角色分配BookStore相关权限：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNEOXVadVF4bVZpYlNHVExDc2s2bENkTlNCY0RXRVk5RTdZNU0zWTdpYTNhODBtS1NhaWNqbmpiUGcvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p>然后就可以看到book菜单了，包括基本的增删改查界面：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWMzTUZrb3lpY2VOWkhQcEF5Q1JjMmczdFRUdnNsa3h4UFhpYkRTSHdWblI0anRHcHpsZjhvRk1SQS82NDA?x-oss-process=image/format,png" alt="img"></p>
<p>至此就完成了一个基本功能的开发，AbpHelper确实很方便，他还有CLI版本，直接命令行操作。</p>
<h3 id="模块安装"><a href="#模块安装" class="headerlink" title="模块安装"></a>模块安装</h3><p>ABP的模块化可以实现插件式的开发，你可以预先构建一些通用的模块，比如日志模块，用户模块等等，当你以后需要时就可以直接安装到项目中。有一些由ABP社区开发和维护的开源免费的应用程序模块，我们可以直接使用；比如我要使用官方的Blogging模块，Blogging是用于创建精美的博客。</p>
<p>同样使用AbpHelper来安装：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNXMURucDVtNkdhZ29Ja2xMWTdSczcwSmNteEVRRmFlTmtJTWp4cGlhalYybFFuZGtOQ09TaWN3dy82NDA?x-oss-process=image/format,png" alt="img"></p>
<p>安装过程出了点小问题，提示找不到DbContext。。。不过没关系，自己执行一下迁移命令就行。。。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWN4a1lmSGlidk1sQ3MzVzQ1em5XdkZlU2lhWFpPZTFsNEtiUWlhR3FqMFF1aWJZMTZQTzFYdVlPY21RLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>Acme.BookStore.Web项目设为启动项，默认项目为Acme.BookStore.EntityFrameworkCore.DbMigrations，然后执行：</p>
<pre><code>Add-Migration AddedBlogging
Update-DataBase
</code></pre>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWN3Nm1URDk3ZXRGbjRRYWFQOThPQ1hOczdsNDYzQlVQVXVndGRjaEVsNW9VYkVmSHRJam9iSncvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p>接下来再次运行Acme.BookStore.Web项目，为admin角色配置博客相关的权限：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNRaWNKd0ptUVBFZFZVWFdwSkFhNHNnTUFiaWM5NnhGMnVqYUR6dmxMWE05NjJDdzRpYjBOUmN2c0EvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p>然后就就可以看到博客的相关功能：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWM0WGVKWWlhMGR0V1pxWDRFeFdJT0oxWk9aQ2t0WlE4cGJqZGdnalhidkg1eWF4UDhaWGxpYTh1US82NDA?x-oss-process=image/format,png" alt="img"></p>
<p>Swagger：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSW1mTjFSaFRyT2NGQkU5a1ZTU3JIaWNNVlM0TndxMDdVQk9xZWEySHl0OUd3dG1tVlp1a3g1eW5MaWFPRGlieGRKUUdlalpUY2lhak14aWFnLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>当然，这些模块不一定完全符合你的要求，你可能需要稍作修改，ABP也允许你扩展实体，重写服务包括重写用户界面，你可以很方便的修改。这些后面再介绍，包括如何去开发这种模块。。。</p>
<h2 id="初识ABP-vNext（3）：vue对接ABP基本思路"><a href="#初识ABP-vNext（3）：vue对接ABP基本思路" class="headerlink" title="初识ABP vNext（3）：vue对接ABP基本思路"></a>初识ABP vNext（3）：vue对接ABP基本思路</h2><p><img src="https://csdnimg.cn/release/blogv2/dist/pc/img/reprint.png" alt="img"></p>
<ul>
<li>登录</li>
<li>权限</li>
<li>本地化</li>
<li>创建项目</li>
<li><ul>
<li>ABP</li>
<li>vue-element-admin</li>
</ul>
</li>
</ul>
<h3 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h3><p>上一篇介绍了ABP的启动模板以及AbpHelper工具的基本使用，这一篇将进入项目实战部分。因为目前ABP的官方模板只支持MVC和Angular，MVC的话咱.NET开发人员来写还可以，专业前端估计很少会用这个。。。Angular我本人不熟，所以选择vue来做UI。</p>
<h3 id="开始-2"><a href="#开始-2" class="headerlink" title="开始"></a>开始</h3><p>我使用vue-element-admin[1]来作为模板，这个项目貌似很多人用，选择他的i18n[2]分支，因为我需要国际化功能。在开始编码前，需要先分析几个重要问题：</p>
<ul>
<li>用户登录/token</li>
<li>用户权限控制</li>
<li>应用程序本地化/语言切换</li>
</ul>
<p>好在ABP模板提供了Angular版本，我们可以参考Angular版本来做。</p>
<h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><p>因为ABP的授权模块是使用IdentityServer4，所以IdentityServer4的一些默认端点在ABP里也是同样有效的，可以参考下IdentityServer4官网[3]。运行ABP模板项目，看一下IdentityServer4发现文档，uri是：<code>/.well-known/openid-configuration</code></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDViaWEySDhWTjNoVlF2Y3ppY0lKcnl4c1k0VkFzcU9udWNVVWlhNTNmZWJvQjZjbmVxU0hpYVNSaWN3QS82NDA?x-oss-process=image/format,png" alt="img"></p>
<p>可以看到token端点是<code>/connect/token</code>，这是IdentityServer4默认的，通过这个端点就可以登录用户获取token。后面请求接口时，把token放到HTTP Header的authorization字段即可。</p>
<h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><p>进入ABP的<code>/swagger</code>界面：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDVHWGlheG92NDBoaWNvQjNabGRzYVB5OEpyOE9tWGpuV0tyTUQ3bVVvZGtPVEcwak1oTFAxSkRhZy82NDA?x-oss-process=image/format,png" alt="img"></p>
<p>ABP内置了一个<code>/api/abp/application-configuration</code>接口，它用于返回本地化文本，权限和一些系统设置信息。看一下数据格式：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDVYTTBnSTZhTzFRbmFNZzNhcWN5ZFhORTlpYWtMNEtQWE0zY250c2p5RlVXbjFqVkVyNnRuektnLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>在<strong>auth.policies</strong>字段中包含了系统的所有权限，<strong>auth.grantedPolicies</strong>字段则包含了当前用户所拥有的权限，因为我现在没登录所以是空的。通过这两个字段就可以和vue-element-admin的菜单权限对应起来，实现权限控制。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDVweVFTRzMyd0tQOGdQcmZOMW1YOERyY0xkUjlpY1hOeVRqaWIyN2ljc0F6WUVBNXF0eWxvOE01M3cvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p><strong>currentUser</strong>字段表示当前用户信息，没登录时就是空的，<strong>isAuthenticated</strong>为false，这个字段也可以作为用户是否登录（token是否有效）的判断依据。</p>
<h3 id="本地化"><a href="#本地化" class="headerlink" title="本地化"></a>本地化</h3><p>本地化对于大部分的小型系统可能都用不上，不过ABP作为一个优秀且全面的框架，必然会支持本地化功能。同样的，本地化信息也可以通过<code>/api/abp/application-configuration</code>接口来获取：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDVyTlM3NHd2UHpicGNOZnYwQTJaWjFYSDNnZ3U1anFhQWZCMm5wQXNGWWljRkx2TURlSnpjQ0h3LzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p><strong>localization.languages</strong>字段表示系统所支持的语言类型，前端的语言切换选项就可以使用这个字段。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDVLeGliUHpucXJGenByOXRKVjBhVzdDQmY3SjZuV09aRU5QNFpualhNUHUwRnVpY0pSaWNZSnM3d1EvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p><strong>localization.values</strong>字段就是本地化的文本信息了，你在后端配置的本地化文本都可以从这里获取到，通过这个字段结合vue-element-admin的国际化功能，就可以让你的系统支持多语言。vue-element-admin的国际化方案是通过 vue-i18n[4]来实现，你也可以直接在前端部分来做国际化，如果你只有一个前端应用的话，但是在后端做复用性更好一些。</p>
<p>语言切换时只需要把对应的语言名称放到HTTP Header的accept-language字段就行。</p>
<h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>在开始编码前，先创建好前后端的模板项目。</p>
<p>ABP</p>
<p>这里直接用Abp CLI命令来创建解决方案吧：</p>
<pre class=" language-go"><code class="language-go">abp <span class="token builtin">new</span> <span class="token string">"Xhznl.HelloAbp"</span>



<span class="token operator">-</span>t app



<span class="token operator">-</span>u none <span class="token operator">--</span>separate<span class="token operator">-</span>identity<span class="token operator">-</span>server



<span class="token operator">-</span>m none



<span class="token operator">-</span>d ef <span class="token operator">-</span>cs <span class="token string">"Server=localhost;User Id=sa;Password=Password@2020;Database=HelloAbp;MultipleActiveResultSets=true"</span>
</code></pre>
<p>创建一个名为”Xhznl.HelloAbp”的解决方案，使用app作为模板，不需要UI，并且将Identity Server应用程序与API host应用程序分开，使用Entity Framework Core作为数据库提供程序，并指定连接字符串。创建完成后会得到一个aspnet-core文件夹。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDV3aWI5cVdhZnJraEJyR3ExNDl1QVJ2NG82WmhMVnNRRzhLdFkwNUxzREc1QTlaUG5LZmRqdmtBLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>项目结构如下，因为指定了<code>--separate-identity-server</code>参数，所以多了个IdentityServer项目，如果不指定的话它是集成在HttpApi.Host中的。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDU2YzVEWmlhRnRpY0hiNkNpYWpEczNWTnB2bG5pY2N4Y01OeHN2RGljenJMUXdqSjdKWUZVTTJ4Ykx6QS82NDA?x-oss-process=image/format,png" alt="img"></p>
<p>通常小型系统没必要把Identity Server应用程序与API host应用程序分开，会增加运维成本，这里只是为了演示分布式部署的情况，为后面的微服务做准备。</p>
<p>ABP还支持为每个模块单独配置数据库（如果你不需要分库，可以忽略以下内容），修改DbMigrator、IdentityServer项目的appsettings.json配置文件：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDV6WWljNWRJRzllS2w1c2w5MTBLTE14dFBjYmMyQVpxamdSblVGRXdzM1F4M3BkblJBNkJOTEtnLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>在ConnectionStrings中添加AbpIdentityServer配置，为Identity Server配置独立的数据库连接字符串，不配置的话默认使用Default配置。AbpIdentityServer这个key是来自ABP的IdentityServer模块中的一个常量，具体请参考源码。</p>
<p>在开发环境光定义连接字符串还不够，因为HelloAbpIdsDB数据库还不存在，需要使用EF Core Code Frist迁移系统创建和维护这个数据库。新建一个项目：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDV4Z1BkN1FKcUtaQ3FIcTIyblZrN2VhaWNSd0lmUUJnRlNCNXZ5Nm9Rb25uakNJNGVwa3RKMGx3LzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>步骤比较多，具体流程请参考官网：数据库迁移[5]，这里就不重复介绍了，你也可以选择不分库。</p>
<p>完成以上步骤，最终会生成2个数据库，并且包含了一些默认的种子数据。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDU2aWN4aWNhTmJrY1NsQXJraWJuS2ZnTGwzN2VpY0xUdFRmMjBzVmppYUdpYTZ0eFdrcFlRYTJjT1M1VlEvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p>然后验证一下HttpApi.Host和IdentityServer项目是否可以正常运行，前提是你电脑需要有sqlserver，redis。</p>
<p>HttpApi.Host：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDV6Q0t2Nmo5cHc2aWN5cFVBdXJPQVBVRndhNDExZmhBaWNDTHFSeWlhT1lvRmRRNXoyVlFaU3pCVkEvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p>IdentityServer：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDV1REw0eUVMU1hxOEczalNVbWlhWXpQTlJ3anZPVVFmc1FYNW9hWE9ucTlHcVB3aWNzRkVCS0pUQS82NDA?x-oss-process=image/format,png" alt="img"></p>
<h3 id="vue-element-admin"><a href="#vue-element-admin" class="headerlink" title="vue-element-admin"></a>vue-element-admin</h3><p>vue-element-admin的基本使用就不介绍了，相信很多人见过这个，不了解的可以自己去搜索学习一下。</p>
<p>去GitHub下载i18n[6]分支的代码，或者直接用git clone命令。</p>
<p>在项目根目录下执行指令：</p>
<p>安装依赖：<code>npm install</code></p>
<p>启动项目：<code>npm run dev</code></p>
<p>启动正常的话可以看到这个界面：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszTDdKSm53cHFDOXpLUERlTWliWmNxZDVyaWFpYmsyNEZoRGdHd0JvbmZWaktYTVBLbVFPa3pidDlIUXQ1ejRZUUkwb0lnZTNrTkhmajZZUS82NDA?x-oss-process=image/format,png" alt="img"></p>
<h1 id><a href="#" class="headerlink" title></a></h1><h2 id="初识ABP-vNext（6）：vue-ABP实现国际化"><a href="#初识ABP-vNext（6）：vue-ABP实现国际化" class="headerlink" title="初识ABP vNext（6）：vue+ABP实现国际化"></a>初识ABP vNext（6）：vue+ABP实现国际化</h2><p><img src="https://csdnimg.cn/release/blogv2/dist/pc/img/reprint.png" alt="img"></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSnNYaWFZWjYya0Yya0VOZFVIMlY3QkRFZnFIMHJoeGxPOUZmMFlzSFlmUDhpYzhRUWdRUnV6bGljMjJta1VrSzZjN2RHT3AwcnNUR2NVUS82NDA?x-oss-process=image/format,png" alt="img"></p>
<ul>
<li>语言选项</li>
<li>语言切换</li>
<li><ul>
<li>注意</li>
</ul>
</li>
</ul>
<h3 id="前言-3"><a href="#前言-3" class="headerlink" title="前言"></a>前言</h3><p>上一篇介绍了ABP扩展实体，并且在前端部分新增了身份认证管理和租户管理的菜单，在实现这两个功能模块前，先来解决一下界面文字国际化的问题。</p>
<h3 id="开始-3"><a href="#开始-3" class="headerlink" title="开始"></a>开始</h3><p>国际化（简称 I18N），本地化（简称 L10N）；这两者的目的都是用于让你的应用程序支持多个国家和区域的语言，它们看起来很相似，但是有一些细微的区别，本文不对此进行深入探讨，有兴趣的可以自行搜索。ABP后端支持的是本地化，而vue-element-admin支持的是国际化，使用<strong>vue-i18n</strong>实现；本文默认它两者是一回事。</p>
<p>前面的章节中，已经大概分析了vue+ABP国际化的实现思路。我们可以在后端实现国际化，然后vue从后端获取国际化文本，展示到界面中；另一种方式是直接在前端部分实现国际化。在前端实现就很简单，直接在vue-element-admin的<code>src\lang\</code>目录下配置相应的文本，然后界面使用i18n的<code>$t()</code>方法渲染就可以了，这个不多做介绍。本文只探讨第一种实现方式。</p>
<h3 id="语言选项"><a href="#语言选项" class="headerlink" title="语言选项"></a>语言选项</h3><p>首先，语言选项列表需要根据后端配置得到。</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkhFbEVlcEppYzVZelFCYUR6cDlzSUI2MTF0dGgwQzM1bDVrd0dIM2phYW92bnJsOEhSQW1zQTZBLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>在后端修改支持的语言类型，这里就只支持中文和英文2种吧，其他的注释掉。</p>
<p>src\Xhznl.HelloAbp.HttpApi.Host\HelloAbpHttpApiHostModule.cs：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkhPSkx6anJUVWlhNUtTaWFYTTJGaWE1R09uWW1kd3dtaWE0QUd6MFJNelJMSWtwR01rMDVJUll0dUVRLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>请求<code>abp/application-configuration</code>接口：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkhZZll5WnFyZnJLdEE5M1RhaWFrSWEzRXhMSXNvaWJJdUQxN0NsOVB0SHRtclhMR01OaWNkaWJCY0FRLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>此时返回的localization.languages属性只有2个语言了，然后只需要把这个数据绑定到界面上就好了。语言切换用的是一个公共组件 src\components\LangSelect\index.vue：</p>
<pre class=" language-go"><code class="language-go"><span class="token operator">&lt;</span>template<span class="token operator">></span>



  <span class="token operator">&lt;</span>el<span class="token operator">-</span>dropdown



    trigger<span class="token operator">=</span><span class="token string">"click"</span>



    class<span class="token operator">=</span><span class="token string">"international"</span>



    @command<span class="token operator">=</span><span class="token string">"handleSetLanguage"</span>



  <span class="token operator">></span>



    <span class="token operator">&lt;</span>div<span class="token operator">></span>



      <span class="token operator">&lt;</span>svg<span class="token operator">-</span>icon class<span class="token operator">-</span>name<span class="token operator">=</span><span class="token string">"international-icon"</span> icon<span class="token operator">-</span>class<span class="token operator">=</span><span class="token string">"language"</span> <span class="token operator">/</span><span class="token operator">></span>



    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>



    <span class="token operator">&lt;</span>el<span class="token operator">-</span>dropdown<span class="token operator">-</span>menu slot<span class="token operator">=</span><span class="token string">"dropdown"</span><span class="token operator">></span>



      <span class="token operator">&lt;</span>el<span class="token operator">-</span>dropdown<span class="token operator">-</span>item



        v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"item in languages"</span>



        <span class="token punctuation">:</span>key<span class="token operator">=</span><span class="token string">"item.cultureName"</span>



        <span class="token punctuation">:</span>disabled<span class="token operator">=</span><span class="token string">"language === item.cultureName"</span>



        <span class="token punctuation">:</span>command<span class="token operator">=</span><span class="token string">"item.cultureName"</span>



      <span class="token operator">></span>



        <span class="token punctuation">{</span><span class="token punctuation">{</span> item<span class="token punctuation">.</span>displayName <span class="token punctuation">}</span><span class="token punctuation">}</span>



      <span class="token operator">&lt;</span><span class="token operator">/</span>el<span class="token operator">-</span>dropdown<span class="token operator">-</span>item<span class="token operator">></span>



    <span class="token operator">&lt;</span><span class="token operator">/</span>el<span class="token operator">-</span>dropdown<span class="token operator">-</span>menu<span class="token operator">></span>



  <span class="token operator">&lt;</span><span class="token operator">/</span>el<span class="token operator">-</span>dropdown<span class="token operator">></span>



<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span>



 



<span class="token operator">&lt;</span>script<span class="token operator">></span>



export <span class="token keyword">default</span> <span class="token punctuation">{</span>



  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>



    <span class="token keyword">return</span> <span class="token punctuation">{</span>



      languages<span class="token punctuation">:</span> this<span class="token punctuation">.</span>$store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>abpConfig<span class="token punctuation">.</span>localization<span class="token punctuation">.</span>languages



    <span class="token punctuation">}</span><span class="token punctuation">;</span>



  <span class="token punctuation">}</span><span class="token punctuation">,</span>



  computed<span class="token punctuation">:</span> <span class="token punctuation">{</span>



    <span class="token function">language</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>



      <span class="token keyword">return</span> this<span class="token punctuation">.</span>$store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>language<span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



  <span class="token punctuation">}</span><span class="token punctuation">,</span>



  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>



    <span class="token function">handleSetLanguage</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span> <span class="token punctuation">{</span>



      <span class="token comment" spellcheck="true">//this.$i18n.locale = lang</span>



      this<span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">"app/setLanguage"</span><span class="token punctuation">,</span> lang<span class="token punctuation">)</span><span class="token punctuation">;</span>



      this<span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">"app/applicationConfiguration"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>



        this<span class="token punctuation">.</span>$<span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">{</span>



          message<span class="token punctuation">:</span> <span class="token string">"Switch Language Success"</span><span class="token punctuation">,</span>



          <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">"success"</span>



        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



  <span class="token punctuation">}</span>



<span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
</code></pre>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkhXdmV3b3ZMYmlhQWNjaWNMSGliSXlCOTNERmU5d1BTa3RxQmtvelI5Y0xxWTNUbkt5WnVjT2ZwMWcvNjQw?x-oss-process=image/format,png" alt="img"></p>
<h3 id="语言切换"><a href="#语言切换" class="headerlink" title="语言切换"></a>语言切换</h3><p>语言切换时，需要再次调用<code>app/applicationConfiguration</code>接口，更新本地化文本。</p>
<p>src\utils\request.js：</p>
<pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// request interceptor</span>



service<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>



  config <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>



    <span class="token comment" spellcheck="true">// do something before request is sent</span>



    config<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'accept-language'</span><span class="token punctuation">]</span> <span class="token operator">=</span> store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>language



 



    <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>



      config<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'authorization'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Bearer '</span> <span class="token operator">+</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>



    <span class="token punctuation">}</span>



    <span class="token keyword">return</span> config



  <span class="token punctuation">}</span><span class="token punctuation">,</span>



  <span class="token builtin">error</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>



    <span class="token comment" spellcheck="true">// do something with request error</span>



    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// for debug</span>



    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">)</span>



  <span class="token punctuation">}</span>



<span class="token punctuation">)</span>
</code></pre>
<p>src\store\modules\app.js：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">const</span> actions <span class="token operator">=</span> <span class="token punctuation">{</span>



  。。。。。。



    



  <span class="token function">applicationConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">{</span> commit <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>



    <span class="token keyword">return</span> <span class="token builtin">new</span> <span class="token function">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>



      <span class="token function">applicationConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>



        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>response <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>



          <span class="token keyword">const</span> data <span class="token operator">=</span> response<span class="token punctuation">;</span>



          <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">"SET_ABPCONFIG"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>



 



          <span class="token keyword">const</span> language <span class="token operator">=</span> data<span class="token punctuation">.</span>localization<span class="token punctuation">.</span>currentCulture<span class="token punctuation">.</span>cultureName<span class="token punctuation">;</span>



          <span class="token keyword">const</span> values <span class="token operator">=</span> data<span class="token punctuation">.</span>localization<span class="token punctuation">.</span>values<span class="token punctuation">;</span>



          <span class="token function">setLocale</span><span class="token punctuation">(</span>language<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>



 



          <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token punctuation">}</span><span class="token punctuation">)</span>



        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token builtin">error</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>



          <span class="token function">reject</span><span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



  <span class="token punctuation">}</span>



<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>src\lang\index.js：</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> Vue from <span class="token string">"vue"</span><span class="token punctuation">;</span>



<span class="token keyword">import</span> VueI18n from <span class="token string">"vue-i18n"</span><span class="token punctuation">;</span>



<span class="token keyword">import</span> Cookies from <span class="token string">"js-cookie"</span><span class="token punctuation">;</span>



<span class="token keyword">import</span> elementEnLocale from <span class="token string">"element-ui/lib/locale/lang/en"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// element-ui lang</span>



<span class="token keyword">import</span> elementZhLocale from <span class="token string">"element-ui/lib/locale/lang/zh-CN"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// element-ui lang</span>



 



Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueI18n<span class="token punctuation">)</span><span class="token punctuation">;</span>



 



<span class="token keyword">const</span> messages <span class="token operator">=</span> <span class="token punctuation">{</span>



  en<span class="token punctuation">:</span> <span class="token punctuation">{</span>



    <span class="token operator">...</span>elementEnLocale



  <span class="token punctuation">}</span><span class="token punctuation">,</span>



  <span class="token string">"zh-Hans"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>



    <span class="token operator">...</span>elementZhLocale



  <span class="token punctuation">}</span>



<span class="token punctuation">}</span><span class="token punctuation">;</span>



 



export function <span class="token function">getLanguage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>



  <span class="token keyword">const</span> chooseLanguage <span class="token operator">=</span> Cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"language"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



  <span class="token keyword">if</span> <span class="token punctuation">(</span>chooseLanguage<span class="token punctuation">)</span> <span class="token keyword">return</span> chooseLanguage<span class="token punctuation">;</span>



 



  <span class="token comment" spellcheck="true">// if has not choose language</span>



  <span class="token keyword">const</span> language <span class="token operator">=</span> <span class="token punctuation">(</span>



    navigator<span class="token punctuation">.</span>language <span class="token operator">||</span> navigator<span class="token punctuation">.</span>browserLanguage



  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



  <span class="token keyword">const</span> locales <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>



  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> locale of locales<span class="token punctuation">)</span> <span class="token punctuation">{</span>



    <span class="token keyword">if</span> <span class="token punctuation">(</span>language<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>locale<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>



      <span class="token keyword">return</span> locale<span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



  <span class="token punctuation">}</span>



  <span class="token keyword">return</span> <span class="token string">"en"</span><span class="token punctuation">;</span>



<span class="token punctuation">}</span>



export function <span class="token function">setLocale</span><span class="token punctuation">(</span>language<span class="token punctuation">,</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>



  i18n<span class="token punctuation">.</span><span class="token function">mergeLocaleMessage</span><span class="token punctuation">(</span>language<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>



  i18n<span class="token punctuation">.</span>locale <span class="token operator">=</span> language<span class="token punctuation">;</span>



<span class="token punctuation">}</span>



<span class="token keyword">const</span> i18n <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">VueI18n</span><span class="token punctuation">(</span><span class="token punctuation">{</span>



  <span class="token comment" spellcheck="true">// set locale</span>



  <span class="token comment" spellcheck="true">// options: en | zh | es</span>



  locale<span class="token punctuation">:</span> <span class="token function">getLanguage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>



  <span class="token comment" spellcheck="true">// set locale messages</span>



  messages



<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



 



export <span class="token keyword">default</span> i18n<span class="token punctuation">;</span>
</code></pre>
<p>将后端返回的文本设置到vue-i18n中，就可以使用了。这跟直接在前端做国际化有一点区别就是，后者的文本信息是写在前端，vue-i18n可以直接使用。而这里只是把文本信息改到后端，从后端获取后再设置到i18n中，本质是一样的。</p>
<p>修改后端的配置文本：</p>
<p>src\Xhznl.HelloAbp.Domain.Shared\Localization\HelloAbp\zh-Hans.json：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkhFRENwTFJrZlBGczBLRG1xTlp5VVFScU1TVFhpY1NUUm01N2ZKTTVZQUo1eWlibnJIQTFpYjlVb1EvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p>src\Xhznl.HelloAbp.Domain.Shared\Localization\HelloAbp\en.json：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkhOaWN0R0x6eUlPaWNmTXNJMWxQMDRqaWFDbGljcXlvNno3Mjl3cWd1R2VBeU11bERZaWJJMHZUV29ydy82NDA?x-oss-process=image/format,png" alt="img"></p>
<p>localization.values返回：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkhZYmIwUHJvbjlFbXQzTVVsdUZ6OUJlWHFIYnpZREFjRTJJVkhUb0FuSURvWURHTk1WSHlJTHcvNjQw?x-oss-process=image/format,png" alt="img"></p>
<p>接下来只需要把界面上对应的文本使用vue-i18n的<code>$t()</code>方法渲染就好了，比如：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkhoelRuOHZiMTl1ZHp5ZmRUaE03cFhiazA1WGliaFRpYlRZeUVqeTFJY0xDZ2FaVVFBMGpUUFo4QS82NDA?x-oss-process=image/format,png" alt="img"></p>
<p>前端需要改动的地方比较多，但都是类似的修改。。。直接看效果：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkhKZGZMQmlicWJpYTRXWk1lTUpyQVNaYXRyd1k1MDhBWk9mcVFUaWNtajRpYkYwb0hCeExwQm41UU1nLzY0MA?x-oss-process=image/format,png" alt="img"> <img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkg2ekFzejY5ZnVyckxpYVZCS0xWZ0tlZ2hpYnNhQmYzQVRIdU00cDlZTE1tQTdUeDBCdTBGRzlxZy82NDA?x-oss-process=image/format,png" alt="img"> <img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X2dpZi9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkg2U212eVhHWjNzTU1DaWJINzR5dUVUa2lhSGZXVXZmeWhGM2NzeER3bEJLQWVNRGJtNHBwWmhIUS82NDA?x-oss-process=image/format,png" alt="img"></p>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>因为<code>app/applicationConfiguration</code>接口只有在刷新页面、登录、退出、切换语言等操作的时候才会去调用，所以不用担心请求频繁。</p>
<p>其实上面有一部分本地化文本还是放在了前端：ElementUI自带的文本。因为ABP的本地化json格式只能有一级，key/value：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkhqeWljZzExbkhRUXh6YjhpYTFyZ3NZRFMxUjFpYzExM2xyVWJhcE4zdk9sdEZ1SUlhaWNMWWMxRzZnLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>文本只能写在texts属性中，key/value形式，不支持多层级。</p>
<p>而vue-i18n是支持多层级的：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSTlLazludlRmY2RMVFNMSXJOUmljVkh6bWlhRDN4Ymc1QVRPUHNWRlp2UkRGWkEyM0lieTlUSUFIWlZEOHNDN3VDbkVQWEFjVjNSWUZ3LzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>所以ElementUI的这部分文本还是放在前端了。</p>
<h1 id="初识ABP-vNext（9）：ABP模块化开发-文件管理"><a href="#初识ABP-vNext（9）：ABP模块化开发-文件管理" class="headerlink" title="初识ABP vNext（9）：ABP模块化开发-文件管理"></a>初识ABP vNext（9）：ABP模块化开发-文件管理</h1><p><img src="https://csdnimg.cn/release/blogv2/dist/pc/img/reprint.png" alt="img"></p>
<h3 id="前言-4"><a href="#前言-4" class="headerlink" title="前言"></a>前言</h3><p>在之前的章节中介绍过ABP扩展实体，当时在用户表扩展了用户头像字段，用户头像就涉及到文件上传和文件存储。文件上传是很多系统都会涉及到的一个基础功能，在ABP的模块化思路下，文件管理可以做成一个通用的模块，便于以后在多个项目中复用。单纯实现一个文件上传的功能并不复杂，本文就借着这个简单的功能来介绍一下ABP模块化开发的最基本步骤。</p>
<h3 id="开始-4"><a href="#开始-4" class="headerlink" title="开始"></a>开始</h3><h4 id="创建模块"><a href="#创建模块" class="headerlink" title="创建模块"></a>创建模块</h4><p>首先使用ABP CLI创建一个模块：<code>abp new Xhznl.FileManagement -t module --no-ui</code></p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200910172558639-780117902.png" alt="img"></p>
<p>创建完成后会得到如下文件：</p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200910172811988-1656283782.png" alt="img"></p>
<p>在主项目中添加对应模块的引用，Application=&gt;Application，Domain=&gt;Domain，HttpApi=&gt;HttpApi 等等。例如：</p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200910174159657-385790504.png" alt="img"></p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200910174252923-1500539398.png" alt="img"></p>
<p>需要添加引用的项目：Application、Application.Contracts、Domain、Domain.Shared、EntityFrameworkCore、HttpApi、HttpApi.Client</p>
<p>手动添加这些引用比较麻烦，你可以搭建自己的私有NuGet服务器，把模块的包发布到私有NuGet上，然后通过NuGet来安装引用。两种方式各有优缺点，具体请参考<a target="_blank" rel="noopener" href="https://docs.abp.io/zh-Hans/abp/latest/Customizing-Application-Modules-Guide">自定义现有模块</a>，关于私有NuGet搭建可以参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/xhznl/p/13426918.html">十分钟搭建自己的私有NuGet服务器-BaGet</a>。</p>
<p>然后给这些项目的模块类添加对应的依赖，例如：</p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200910194927720-1698177383.png" alt="img"></p>
<p>通过上面的方式引用模块，使用visual studio是无法编译通过的：</p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200910174502648-1014353291.png" alt="img"></p>
<p>需要在解决方案目录下，手动执行<code>dotnet restore</code>命令即可：</p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200910175401258-1508422500.png" alt="img"></p>
<h3 id="模块开发"><a href="#模块开发" class="headerlink" title="模块开发"></a>模块开发</h3><p>接下来关于文件管理功能的开发，都在模块Xhznl.FileManagement中进行，它是一个独立的解决方案。初学ABP，下面就以尽量简单的方式来实现这个模块。</p>
<h3 id="应用服务"><a href="#应用服务" class="headerlink" title="应用服务"></a>应用服务</h3><p>模块开发通常从Domain层实体建立开始，但是这里先跳过。先在FileManagement.Application.Contracts项目添加应用服务接口和Dto。</p>
<p>modules\file-management\src\Xhznl.FileManagement.Application.Contracts\Files\IFileAppService.cs：</p>
<pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFileAppService</span> <span class="token punctuation">:</span> IApplicationService



<span class="token punctuation">{</span>



    Task<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>



 



    Task<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span>FileUploadInputDto input<span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token punctuation">}</span>
</code></pre>
<p>modules\file-management\src\Xhznl.FileManagement.Application.Contracts\Files\FileUploadInputDto.cs：</p>
<pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUploadInputDto</span>



<span class="token punctuation">{</span>



    <span class="token punctuation">[</span>Required<span class="token punctuation">]</span>



    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> Bytes <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>



 



    <span class="token punctuation">[</span>Required<span class="token punctuation">]</span>



    <span class="token keyword">public</span> <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>



<span class="token punctuation">}</span>
</code></pre>
<p>然后是FileManagement.Application项目，实现应用服务，先定义一个配置类。</p>
<p>modules\file-management\src\Xhznl.FileManagement.Application\Files\FileOptions.cs：</p>
<pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileOptions</span>



<span class="token punctuation">{</span>



    <span class="token comment" spellcheck="true">/// &lt;summary></span>



    <span class="token comment" spellcheck="true">/// 文件上传目录</span>



    <span class="token comment" spellcheck="true">/// &lt;/summary></span>



    <span class="token keyword">public</span> <span class="token keyword">string</span> FileUploadLocalFolder <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>



 



    <span class="token comment" spellcheck="true">/// &lt;summary></span>



    <span class="token comment" spellcheck="true">/// 允许的文件最大大小</span>



    <span class="token comment" spellcheck="true">/// &lt;/summary></span>



    <span class="token keyword">public</span> <span class="token keyword">long</span> MaxFileSize <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">1048576</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//1MB</span>



 



    <span class="token comment" spellcheck="true">/// &lt;summary></span>



    <span class="token comment" spellcheck="true">/// 允许的文件类型</span>



    <span class="token comment" spellcheck="true">/// &lt;/summary></span>



    <span class="token keyword">public</span> <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> AllowedUploadFormats <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".jpeg"</span><span class="token punctuation">,</span> <span class="token string">".png"</span><span class="token punctuation">,</span> <span class="token string">"gif"</span><span class="token punctuation">,</span> <span class="token string">".txt"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token punctuation">}</span>
</code></pre>
<p>modules\file-management\src\Xhznl.FileManagement.Application\Files\FileAppService.cs：</p>
<pre class=" language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileAppService</span> <span class="token punctuation">:</span> FileManagementAppService<span class="token punctuation">,</span> IFileAppService



<span class="token punctuation">{</span>



    <span class="token keyword">private</span> <span class="token keyword">readonly</span> FileOptions _fileOptions<span class="token punctuation">;</span>



 



    <span class="token keyword">public</span> <span class="token function">FileAppService</span><span class="token punctuation">(</span>IOptions<span class="token operator">&lt;</span>FileOptions<span class="token operator">></span> fileOptions<span class="token punctuation">)</span>



    <span class="token punctuation">{</span>



        _fileOptions <span class="token operator">=</span> fileOptions<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



 



    <span class="token keyword">public</span> Task<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>



    <span class="token punctuation">{</span>



        Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token function">nameof</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



 



        <span class="token keyword">var</span> filePath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>_fileOptions<span class="token punctuation">.</span>FileUploadLocalFolder<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>



 



        <span class="token keyword">if</span> <span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span>



        <span class="token punctuation">{</span>



            <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">ReadAllBytes</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token punctuation">}</span>



 



        <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



 



    <span class="token punctuation">[</span>Authorize<span class="token punctuation">]</span>



    <span class="token keyword">public</span> Task<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span>FileUploadInputDto input<span class="token punctuation">)</span>



    <span class="token punctuation">{</span>



        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>Bytes<span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>



        <span class="token punctuation">{</span>



            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AbpValidationException</span><span class="token punctuation">(</span><span class="token string">"Bytes can not be null or empty!"</span><span class="token punctuation">,</span>



                <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>ValidationResult<span class="token operator">></span>



                <span class="token punctuation">{</span>



                    <span class="token keyword">new</span> <span class="token class-name">ValidationResult</span><span class="token punctuation">(</span><span class="token string">"Bytes can not be null or empty!"</span><span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"Bytes"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>



                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token punctuation">}</span>



 



        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>Bytes<span class="token punctuation">.</span>Length <span class="token operator">></span> _fileOptions<span class="token punctuation">.</span>MaxFileSize<span class="token punctuation">)</span>



        <span class="token punctuation">{</span>



            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserFriendlyException</span><span class="token punctuation">(</span>$<span class="token string">"File exceeds the maximum upload size ({_fileOptions.MaxFileSize / 1024 / 1024} MB)!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token punctuation">}</span>



 



        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_fileOptions<span class="token punctuation">.</span>AllowedUploadFormats<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">GetExtension</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>



        <span class="token punctuation">{</span>



            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserFriendlyException</span><span class="token punctuation">(</span><span class="token string">"Not a valid file format!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token punctuation">}</span>



 



        <span class="token keyword">var</span> fileName <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"N"</span><span class="token punctuation">)</span> <span class="token operator">+</span> Path<span class="token punctuation">.</span><span class="token function">GetExtension</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token keyword">var</span> filePath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>_fileOptions<span class="token punctuation">.</span>FileUploadLocalFolder<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>



 



        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Directory<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>_fileOptions<span class="token punctuation">.</span>FileUploadLocalFolder<span class="token punctuation">)</span><span class="token punctuation">)</span>



        <span class="token punctuation">{</span>



            Directory<span class="token punctuation">.</span><span class="token function">CreateDirectory</span><span class="token punctuation">(</span>_fileOptions<span class="token punctuation">.</span>FileUploadLocalFolder<span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token punctuation">}</span>



 



        File<span class="token punctuation">.</span><span class="token function">WriteAllBytes</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> input<span class="token punctuation">.</span>Bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>



 



        <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token string">"/api/file-management/files/"</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



<span class="token punctuation">}</span>
</code></pre>
<p>服务实现很简单，就是基于本地文件系统的读写操作。</p>
<p>下面是FileManagement.HttpApi项目，添加控制器，暴露服务API接口。</p>
<p>modules\file-management\src\Xhznl.FileManagement.HttpApi\Files\FileController.cs：</p>
<pre class=" language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>RemoteService<span class="token punctuation">]</span>



<span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"api/file-management/files"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>



<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileController</span> <span class="token punctuation">:</span> FileManagementController



<span class="token punctuation">{</span>



    <span class="token keyword">private</span> <span class="token keyword">readonly</span> IFileAppService _fileAppService<span class="token punctuation">;</span>



 



    <span class="token keyword">public</span> <span class="token function">FileController</span><span class="token punctuation">(</span>IFileAppService fileAppService<span class="token punctuation">)</span>



    <span class="token punctuation">{</span>



        _fileAppService <span class="token operator">=</span> fileAppService<span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



 



    <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>



    <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"{name}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>



    <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>FileResult<span class="token operator">></span> <span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>



    <span class="token punctuation">{</span>



        <span class="token keyword">var</span> bytes <span class="token operator">=</span> <span class="token keyword">await</span> _fileAppService<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token keyword">return</span> <span class="token function">File</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> MimeTypes<span class="token punctuation">.</span><span class="token function">GetByExtension</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">GetExtension</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



 



    <span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>



    <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"upload"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>



    <span class="token punctuation">[</span>Authorize<span class="token punctuation">]</span>



    <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>JsonResult<span class="token operator">></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span>IFormFile file<span class="token punctuation">)</span>



    <span class="token punctuation">{</span>



        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>



        <span class="token punctuation">{</span>



            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserFriendlyException</span><span class="token punctuation">(</span><span class="token string">"No file found!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token punctuation">}</span>



 



        <span class="token keyword">var</span> bytes <span class="token operator">=</span> <span class="token keyword">await</span> file<span class="token punctuation">.</span><span class="token function">GetAllBytesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">await</span> _fileAppService<span class="token punctuation">.</span><span class="token function">CreateAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileUploadInputDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span>



        <span class="token punctuation">{</span>



            Bytes <span class="token operator">=</span> bytes<span class="token punctuation">,</span>



            Name <span class="token operator">=</span> file<span class="token punctuation">.</span>FileName



        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token keyword">return</span> <span class="token function">Json</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



 



<span class="token punctuation">}</span>
</code></pre>
<h3 id="运行模块"><a href="#运行模块" class="headerlink" title="运行模块"></a>运行模块</h3><p>ABP的模板是可以独立运行的，在FileManagement.HttpApi.Host项目的模块类FileManagementHttpApiHostModule配置FileOptions：</p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911132722192-254591885.png" alt="img"></p>
<p>修改FileManagement.HttpApi.Host和FileManagement.IdentityServer项目的数据库连接配置，然后启动这2个项目，不出意外的话可以看到如下界面。</p>
<p>FileManagement.HttpApi.Host：</p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911133218273-1796636936.png" alt="img"></p>
<p>FileManagement.IdentityServer：</p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911133231215-1422063602.png" alt="img"></p>
<p>现在你可以使用postman来测试一下File的2个API，当然也可以编写单元测试。</p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911135241123-1212104739.png" alt="img"></p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911135304435-1298819144.png" alt="img"></p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911135517597-557954077.png" alt="img"></p>
<h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><p>更好的方法是编写单元测试，关于如何做好单元测试可以参考ABP源码，下面只做一个简单示例：</p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911140231014-126474242.png" alt="img"></p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911140410237-1879670126.png" alt="img"></p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911140453574-1542444913.png" alt="img"></p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911140605769-598857386.png" alt="img"></p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911140922024-290909767.png" alt="img"></p>
<h3 id="模块使用"><a href="#模块使用" class="headerlink" title="模块使用"></a>模块使用</h3><p>模块测试通过后，回到主项目。模块引用，模块依赖前面都已经做好了，现在只需配置一下FileOptions，就可以使用了。</p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911144501836-1823056167.png" alt="img"></p>
<p><img src="https://img2020.cnblogs.com/blog/610959/202009/610959-20200911144331274-1016096113.png" alt="img"></p>
<p>目前FileManagement.Domain、FileManagement.Domain.Shared、FileManagement.EntityFrameworkCore这几个项目暂时没用到，项目结构也不是固定的，可以根据自己实际情况来调整。</p>
<h1 id="初识ABP-vNext（10）：ABP设置管理"><a href="#初识ABP-vNext（10）：ABP设置管理" class="headerlink" title="初识ABP vNext（10）：ABP设置管理"></a>初识ABP vNext（10）：ABP设置管理</h1><p><img src="https://csdnimg.cn/release/blogv2/dist/pc/img/reprint.png" alt="img"></p>
<h3 id="前言-5"><a href="#前言-5" class="headerlink" title="前言"></a>前言</h3><p>上一篇介绍了ABP模块化开发的基本步骤，完成了一个简单的文件上传功能。通常的模块都有一些自己的配置信息，比如上篇讲到的<code>FileOptions</code>类，其中配置了文件的上传目录，允许的文件大小和允许的文件类型。配置信息可以通过Configuration[1]（配置）和Options[2]（选项）来完成，ABP还提供了另一种更灵活的方式：Settings[3]（设置），本篇就来介绍一下ABP的设置管理。</p>
<h3 id="开始-5"><a href="#开始-5" class="headerlink" title="开始"></a>开始</h3><p>回顾一下上篇的<code>FileOptions</code>：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSjFRd28yY3NRQzBpYzJpYUNNNld5RmF0aG0zZmpFRXJGNU1ZZW41VFVoSnJ1S05SZHc3eG5XRHI2SEs4N3dsa3V6RGhuRHBDTW84ckVnLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>首先定义了一个<code>FileOptions</code>类，其中包含了几个配置，然后在需要的地方中注入<code>IOptions&lt;FileOptions&gt;</code>就可以使用这些信息了。</p>
<p>当然，模块启动时可以做一些配置修改，比如：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSjFRd28yY3NRQzBpYzJpYUNNNld5RmF0dExTQ3FJd1p1V1pXS2liYnJ0ekJyU1BhdkZYaWNpYW9nUWw1TENub0Z2MjNiZjBhTkVoSTYxazJnLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>无论是配置文件还是这种代码形式的配置，都是程序层面的修改；有些配置不太适合这样做，比如这里的<code>AllowedMaxFileSize</code>和<code>AllowedUploadFormats</code>，它们应该在应用界面上，可以让管理员自行修改。下面就来改造一下程序。</p>
<h3 id="定义设置"><a href="#定义设置" class="headerlink" title="定义设置"></a>定义设置</h3><p>使用设置之前需要先定义它，不同的模块可以拥有不同的设置。</p>
<p>modules\file-management\src\Xhznl.FileManagement.Domain\Settings\FileManagementSettingDefinitionProvider.cs：</p>
<pre class=" language-go"><code class="language-go">public class FileManagementSettingDefinitionProvider <span class="token punctuation">:</span> SettingDefinitionProvider



<span class="token punctuation">{</span>



    public override void <span class="token function">Define</span><span class="token punctuation">(</span>ISettingDefinitionContext context<span class="token punctuation">)</span>



    <span class="token punctuation">{</span>



        <span class="token comment" spellcheck="true">/* Define module settings here.



         * Use names from FileManagementSettings class.



         */</span>



 



        context<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token function">SettingDefinition</span><span class="token punctuation">(</span>



            FileManagementSettings<span class="token punctuation">.</span>AllowedMaxFileSize<span class="token punctuation">,</span>



            <span class="token string">"1024"</span><span class="token punctuation">,</span>



            <span class="token function">L</span><span class="token punctuation">(</span><span class="token string">"DisplayName:FileManagement.AllowedMaxFileSize"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>



            <span class="token function">L</span><span class="token punctuation">(</span><span class="token string">"Description:FileManagement.AllowedMaxFileSize"</span><span class="token punctuation">)</span>



            <span class="token punctuation">)</span>



                <span class="token punctuation">.</span><span class="token function">WithProperty</span><span class="token punctuation">(</span><span class="token string">"Group1"</span><span class="token punctuation">,</span> <span class="token string">"File"</span><span class="token punctuation">)</span>



                <span class="token punctuation">.</span><span class="token function">WithProperty</span><span class="token punctuation">(</span><span class="token string">"Group2"</span><span class="token punctuation">,</span> <span class="token string">"Upload"</span><span class="token punctuation">)</span>



                <span class="token punctuation">.</span><span class="token function">WithProperty</span><span class="token punctuation">(</span><span class="token string">"Type"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>



 



            <span class="token builtin">new</span> <span class="token function">SettingDefinition</span><span class="token punctuation">(</span>



                FileManagementSettings<span class="token punctuation">.</span>AllowedUploadFormats<span class="token punctuation">,</span>



                <span class="token string">".jpg,.jpeg,.png,.gif,.txt"</span><span class="token punctuation">,</span>



                <span class="token function">L</span><span class="token punctuation">(</span><span class="token string">"DisplayName:FileManagement.AllowedUploadFormats"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>



                <span class="token function">L</span><span class="token punctuation">(</span><span class="token string">"Description:FileManagement.AllowedUploadFormats"</span><span class="token punctuation">)</span>



            <span class="token punctuation">)</span>



                <span class="token punctuation">.</span><span class="token function">WithProperty</span><span class="token punctuation">(</span><span class="token string">"Group1"</span><span class="token punctuation">,</span> <span class="token string">"File"</span><span class="token punctuation">)</span>



                <span class="token punctuation">.</span><span class="token function">WithProperty</span><span class="token punctuation">(</span><span class="token string">"Group2"</span><span class="token punctuation">,</span> <span class="token string">"Upload"</span><span class="token punctuation">)</span>



                <span class="token punctuation">.</span><span class="token function">WithProperty</span><span class="token punctuation">(</span><span class="token string">"Type"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">)</span>



            <span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



 



    private static LocalizableString <span class="token function">L</span><span class="token punctuation">(</span><span class="token builtin">string</span> name<span class="token punctuation">)</span>



    <span class="token punctuation">{</span>



        <span class="token keyword">return</span> LocalizableString<span class="token punctuation">.</span>Create<span class="token operator">&lt;</span>FileManagementResource<span class="token operator">></span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



<span class="token punctuation">}</span>
</code></pre>
<p>以上代码定了了2个配置：<code>AllowedMaxFileSize</code>和<code>AllowedUploadFormats</code>，设置了它们的默认值、名称和详细说明。因为本项目使用了EasyAbp的SettingUi模块，所以会有一些<code>Group1</code>，<code>Group2</code>之类的字段，具体介绍可以参考Abp.SettingUi[4]</p>
<h3 id="使用设置"><a href="#使用设置" class="headerlink" title="使用设置"></a>使用设置</h3><p>想读取设置信息，只需注入<code>ISettingProvider</code>即可。因为父类<code>ApplicationService</code>中已经注入，所以这里直接使用<code>SettingProvider</code>就好。获取到配置，然后就可以做一些逻辑处理，比如判断上传文件的大小和格式是否合法：</p>
<pre class=" language-go"><code class="language-go">public class FileAppService <span class="token punctuation">:</span> FileManagementAppService<span class="token punctuation">,</span> IFileAppService



<span class="token punctuation">{</span>



    <span class="token operator">...</span><span class="token operator">...</span>



 



    <span class="token punctuation">[</span>Authorize<span class="token punctuation">]</span>



    public virtual async Task<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span>FileUploadInputDto input<span class="token punctuation">)</span>



    <span class="token punctuation">{</span>



        <span class="token keyword">var</span> allowedMaxFileSize <span class="token operator">=</span> await SettingProvider<span class="token punctuation">.</span>GetAsync<span class="token operator">&lt;</span><span class="token builtin">int</span><span class="token operator">></span><span class="token punctuation">(</span>FileManagementSettings<span class="token punctuation">.</span>AllowedMaxFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//kb</span>



        <span class="token keyword">var</span> allowedUploadFormats <span class="token operator">=</span> <span class="token punctuation">(</span>await SettingProvider<span class="token punctuation">.</span><span class="token function">GetOrNullAsync</span><span class="token punctuation">(</span>FileManagementSettings<span class="token punctuation">.</span>AllowedUploadFormats<span class="token punctuation">)</span><span class="token punctuation">)</span>



            ?<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> StringSplitOptions<span class="token punctuation">.</span>RemoveEmptyEntries<span class="token punctuation">)</span><span class="token punctuation">;</span>



 



        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>Bytes<span class="token punctuation">.</span>Length <span class="token operator">></span> allowedMaxFileSize <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>



        <span class="token punctuation">{</span>



            throw <span class="token builtin">new</span> <span class="token function">UserFriendlyException</span><span class="token punctuation">(</span>L<span class="token punctuation">[</span><span class="token string">"FileManagement.ExceedsTheMaximumSize"</span><span class="token punctuation">,</span> allowedMaxFileSize<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token punctuation">}</span>



 



        <span class="token keyword">if</span> <span class="token punctuation">(</span>allowedUploadFormats <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>allowedUploadFormats<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">GetExtension</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>



        <span class="token punctuation">{</span>



            throw <span class="token builtin">new</span> <span class="token function">UserFriendlyException</span><span class="token punctuation">(</span>L<span class="token punctuation">[</span><span class="token string">"FileManagement.NotValidFormat"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token punctuation">}</span>



 



        <span class="token operator">...</span><span class="token operator">...</span>



    <span class="token punctuation">}</span>



<span class="token punctuation">}</span>
</code></pre>
<p>前端设置界面：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSjFRd28yY3NRQzBpYzJpYUNNNld5RmF0ZFN1MUFHRkVtTk9pYXRRcUhSVGgzN05hRFNRaWFpYW1XTk5ZM1lKZG5jdGJ0YmZmcnhCYVI5OWNBLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>下面可以随便修改下设置，进行测试：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszSjFRd28yY3NRQzBpYzJpYUNNNld5RmF0QUcwaWFNSDJWTlFUMFc1RnFrRkN6TVI1Z05tTDYyaWJlZUplaHRmRk9JS1U0VXpBNUtQdGliTHhRLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<h3 id="-1"><a href="#-1" class="headerlink" title></a></h3><h2 id="初识ABP-vNext（11）：聚合根、仓储、领域服务、应用服务、Blob储存"><a href="#初识ABP-vNext（11）：聚合根、仓储、领域服务、应用服务、Blob储存" class="headerlink" title="初识ABP vNext（11）：聚合根、仓储、领域服务、应用服务、Blob储存"></a>初识ABP vNext（11）：聚合根、仓储、领域服务、应用服务、Blob储存</h2><p><img src="https://csdnimg.cn/release/blogv2/dist/pc/img/reprint.png" alt="img"></p>
<ul>
<li>聚合根</li>
<li>仓储</li>
<li>领域服务</li>
<li><ul>
<li>BLOB储存</li>
</ul>
</li>
<li>应用服务</li>
<li>单元测试</li>
<li>模块引用</li>
</ul>
<h3 id="前言-6"><a href="#前言-6" class="headerlink" title="前言"></a>前言</h3><p>在前两节中介绍了ABP模块开发的基本步骤，试着实现了一个简单的文件管理模块；功能很简单，就是基于本地文件系统来完成文件的读写操作，数据也并没有保存到数据库，所以之前只简单使用了应用服务，并没有用到领域层。而在DDD中领域层是非常重要的一层，其中包含了实体，聚合根，领域服务，仓储等等，复杂的业务逻辑也应该在领域层来实现。本篇来完善一下文件管理模块，将文件记录保存到数据库，并使用ABP BLOB系统来完成文件的存储。</p>
<h3 id="开始-6"><a href="#开始-6" class="headerlink" title="开始"></a>开始</h3><h4 id="聚合根"><a href="#聚合根" class="headerlink" title="聚合根"></a>聚合根</h4><p>首先从实体模型开始，建立File实体。按照DDD的思路，这里的File应该是一个<strong>聚合根</strong>。</p>
<p>\modules\file-management\src\Xhznl.FileManagement.Domain\Files\File.cs：</p>
<pre class=" language-go"><code class="language-go">public class File <span class="token punctuation">:</span> FullAuditedAggregateRoot<span class="token operator">&lt;</span>Guid<span class="token operator">></span><span class="token punctuation">,</span> IMultiTenant



<span class="token punctuation">{</span>



    public virtual Guid? TenantId <span class="token punctuation">{</span> get<span class="token punctuation">;</span> protected set<span class="token punctuation">;</span> <span class="token punctuation">}</span>



 



    <span class="token punctuation">[</span>NotNull<span class="token punctuation">]</span>



    public virtual <span class="token builtin">string</span> FileName <span class="token punctuation">{</span> get<span class="token punctuation">;</span> protected set<span class="token punctuation">;</span> <span class="token punctuation">}</span>



 



    <span class="token punctuation">[</span>NotNull<span class="token punctuation">]</span>



    public virtual <span class="token builtin">string</span> BlobName <span class="token punctuation">{</span> get<span class="token punctuation">;</span> protected set<span class="token punctuation">;</span> <span class="token punctuation">}</span>



 



    public virtual long ByteSize <span class="token punctuation">{</span> get<span class="token punctuation">;</span> protected set<span class="token punctuation">;</span> <span class="token punctuation">}</span>



 



    protected <span class="token function">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>



 



    public <span class="token function">File</span><span class="token punctuation">(</span>Guid id<span class="token punctuation">,</span> Guid? tenantId<span class="token punctuation">,</span> <span class="token punctuation">[</span>NotNull<span class="token punctuation">]</span> <span class="token builtin">string</span> fileName<span class="token punctuation">,</span> <span class="token punctuation">[</span>NotNull<span class="token punctuation">]</span> <span class="token builtin">string</span> blobName<span class="token punctuation">,</span> long byteSize<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">base</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>



    <span class="token punctuation">{</span>



        TenantId <span class="token operator">=</span> tenantId<span class="token punctuation">;</span>



        FileName <span class="token operator">=</span> Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token function">nameof</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        BlobName <span class="token operator">=</span> Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>blobName<span class="token punctuation">,</span> <span class="token function">nameof</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        ByteSize <span class="token operator">=</span> byteSize<span class="token punctuation">;</span>



    <span class="token punctuation">}</span>



<span class="token punctuation">}</span>
</code></pre>
<p>在DbContext中<strong>添加DbSet</strong></p>
<p>\modules\file-management\src\Xhznl.FileManagement.EntityFrameworkCore\EntityFrameworkCore\IFileManagementDbContext.cs：</p>
<pre class=" language-go"><code class="language-go">public <span class="token keyword">interface</span> IFileManagementDbContext <span class="token punctuation">:</span> IEfCoreDbContext



<span class="token punctuation">{</span>



    DbSet<span class="token operator">&lt;</span>File<span class="token operator">></span> Files <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token punctuation">}</span>



<span class="token punctuation">}</span>
</code></pre>
<p>\modules\file-management\src\Xhznl.FileManagement.EntityFrameworkCore\EntityFrameworkCore\FileManagementDbContext.cs：</p>
<pre class=" language-go"><code class="language-go">public class FileManagementDbContext <span class="token punctuation">:</span> AbpDbContext<span class="token operator">&lt;</span>FileManagementDbContext<span class="token operator">></span><span class="token punctuation">,</span> IFileManagementDbContext



<span class="token punctuation">{</span>



    public DbSet<span class="token operator">&lt;</span>File<span class="token operator">></span> Files <span class="token punctuation">{</span> get<span class="token punctuation">;</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span>



 



    <span class="token operator">...</span><span class="token operator">...</span>



<span class="token punctuation">}</span>



 
</code></pre>
<p><strong>配置实体</strong></p>
<p>\modules\file-management\src\Xhznl.FileManagement.EntityFrameworkCore\EntityFrameworkCore\FileManagementDbContextModelCreatingExtensions.cs：</p>
<pre class=" language-go"><code class="language-go">public static void <span class="token function">ConfigureFileManagement</span><span class="token punctuation">(</span>

    this ModelBuilder builder<span class="token punctuation">,</span>

    Action<span class="token operator">&lt;</span>FileManagementModelBuilderConfigurationOptions<span class="token operator">></span> optionsAction <span class="token operator">=</span> null<span class="token punctuation">)</span>
<span class="token punctuation">{</span>


    <span class="token operator">...</span><span class="token operator">...</span>

    builder<span class="token punctuation">.</span>Entity<span class="token operator">&lt;</span>File<span class="token operator">></span><span class="token punctuation">(</span>b <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">//Configure table &amp; schema name</span>
        b<span class="token punctuation">.</span><span class="token function">ToTable</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>TablePrefix <span class="token operator">+</span> <span class="token string">"Files"</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>Schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

        b<span class="token punctuation">.</span><span class="token function">ConfigureByConvention</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//Properties</span>
        b<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>q <span class="token operator">=</span><span class="token operator">></span> q<span class="token punctuation">.</span>FileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasMaxLength</span><span class="token punctuation">(</span>FileConsts<span class="token punctuation">.</span>MaxFileNameLength<span class="token punctuation">)</span><span class="token punctuation">;</span>

        b<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>q <span class="token operator">=</span><span class="token operator">></span> q<span class="token punctuation">.</span>BlobName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasMaxLength</span><span class="token punctuation">(</span>FileConsts<span class="token punctuation">.</span>MaxBlobNameLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        b<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>q <span class="token operator">=</span><span class="token operator">></span> q<span class="token punctuation">.</span>ByteSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<h4 id="仓储"><a href="#仓储" class="headerlink" title="仓储"></a>仓储</h4><p>ABP为每个聚合根或实体提供了 <strong>默认的通用(泛型)仓储</strong> ，其中包含了标准的CRUD操作，注入<code>IRepository&lt;TEntity, TKey&gt;</code>即可使用。通常来说默认仓储就够用了，有特殊需求时也可以自定义仓储。</p>
<p>定义<strong>仓储接口</strong></p>
<p>\modules\file-management\src\Xhznl.FileManagement.Domain\Files\IFileRepository.cs：</p>
<pre class=" language-go"><code class="language-go">public <span class="token keyword">interface</span> IFileRepository <span class="token punctuation">:</span> IRepository<span class="token operator">&lt;</span>File<span class="token punctuation">,</span> Guid<span class="token operator">></span>



<span class="token punctuation">{</span>

    Task<span class="token operator">&lt;</span>File<span class="token operator">></span> <span class="token function">FindByBlobNameAsync</span><span class="token punctuation">(</span><span class="token builtin">string</span> blobName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<p><strong>仓储实现</strong></p>
<p>\modules\file-management\src\Xhznl.FileManagement.EntityFrameworkCore\Files\EfCoreFileRepository.cs：</p>
<pre class=" language-go"><code class="language-go">public class EfCoreFileRepository <span class="token punctuation">:</span> EfCoreRepository<span class="token operator">&lt;</span>IFileManagementDbContext<span class="token punctuation">,</span> File<span class="token punctuation">,</span> Guid<span class="token operator">></span><span class="token punctuation">,</span> IFileRepository

<span class="token punctuation">{</span>

    public <span class="token function">EfCoreFileRepository</span><span class="token punctuation">(</span>IDbContextProvider<span class="token operator">&lt;</span>IFileManagementDbContext<span class="token operator">></span> dbContextProvider<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">base</span><span class="token punctuation">(</span>dbContextProvider<span class="token punctuation">)</span>

    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>


    public async Task<span class="token operator">&lt;</span>File<span class="token operator">></span> <span class="token function">FindByBlobNameAsync</span><span class="token punctuation">(</span><span class="token builtin">string</span> blobName<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>blobName<span class="token punctuation">,</span> <span class="token function">nameof</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> await DbSet<span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">.</span>BlobName <span class="token operator">==</span> blobName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>注册仓储</strong></p>
<p>\modules\file-management\src\Xhznl.FileManagement.EntityFrameworkCore\EntityFrameworkCore\FileManagementEntityFrameworkCoreModule.cs：</p>
<pre class=" language-go"><code class="language-go">public class FileManagementEntityFrameworkCoreModule <span class="token punctuation">:</span> AbpModule
<span class="token punctuation">{</span>
    public override void <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>ServiceConfigurationContext context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
 context<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>AddAbpDbContext<span class="token operator">&lt;</span>FileManagementDbContext<span class="token operator">></span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            options<span class="token punctuation">.</span>AddRepository<span class="token operator">&lt;</span>File<span class="token punctuation">,</span> EfCoreFileRepository<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="领域服务"><a href="#领域服务" class="headerlink" title="领域服务"></a>领域服务</h4><p>定义<strong>领域服务接口</strong></p>
<p>\modules\file-management\src\Xhznl.FileManagement.Domain\Files\IFileManager.cs：</p>
<pre class=" language-go"><code class="language-go">public <span class="token keyword">interface</span> IFileManager <span class="token punctuation">:</span> IDomainService
<span class="token punctuation">{</span>

    Task<span class="token operator">&lt;</span>File<span class="token operator">></span> <span class="token function">FindByBlobNameAsync</span><span class="token punctuation">(</span><span class="token builtin">string</span> blobName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Task<span class="token operator">&lt;</span>File<span class="token operator">></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span><span class="token builtin">string</span> fileName<span class="token punctuation">,</span> <span class="token builtin">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Task<span class="token operator">&lt;</span><span class="token builtin">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">GetBlobAsync</span><span class="token punctuation">(</span><span class="token builtin">string</span> blobName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<p>在实现领域服务之前，先来安装一下ABP Blob系统核心包，因为我要使用blob来存储文件，<code>Volo.Abp.BlobStoring</code>包是必不可少的。</p>
<h4 id="BLOB储存"><a href="#BLOB储存" class="headerlink" title="BLOB储存"></a>BLOB储存</h4><p>BLOB(binary large object)：大型二进制对象；关于BLOB可以参考 BLOB 存储[1] ，这里不多介绍。</p>
<p>安装<code>Volo.Abp.BlobStoring</code>，在Domain项目目录下执行：<code>abp add-package Volo.Abp.BlobStoring</code></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszS1NGQXI4eWNFOTU2WmVxeU5leHhIZ215MFVhRmlhWWRRVWI1ZzI1eFpDeVlGaWEwRHdzc042czhIS0hhQTNJMFRBYWZ4RFRDdllYR0NBLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p><code>Volo.Abp.BlobStoring</code>是BLOB的核心包，它仅包含BLOB的一些基本抽象，想要BLOB系统正常工作，还需要为它配置一个提供程序；这个提供程序暂时不管，将来由模块的具体使用者去提供。这样的好处是模块不依赖特定存储提供程序，使用者可以随意的指定存储到阿里云，Azure，或者文件系统等等。。。</p>
<p><strong>领域服务实现</strong></p>
<p>\modules\file-management\src\Xhznl.FileManagement.Domain\Files\FileManager.cs：</p>
<pre class=" language-go"><code class="language-go">public class FileManager <span class="token punctuation">:</span> DomainService<span class="token punctuation">,</span> IFileManager
<span class="token punctuation">{</span>
    protected IFileRepository FileRepository <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    protected IBlobContainer BlobContainer <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    public <span class="token function">FileManager</span><span class="token punctuation">(</span>IFileRepository fileRepository<span class="token punctuation">,</span> IBlobContainer blobContainer<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

        FileRepository <span class="token operator">=</span> fileRepository<span class="token punctuation">;</span>
        BlobContainer <span class="token operator">=</span> blobContainer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public virtual async Task<span class="token operator">&lt;</span>File<span class="token operator">></span> <span class="token function">FindByBlobNameAsync</span><span class="token punctuation">(</span><span class="token builtin">string</span> blobName<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>blobName<span class="token punctuation">,</span> <span class="token function">nameof</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> await FileRepository<span class="token punctuation">.</span><span class="token function">FindByBlobNameAsync</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public virtual async Task<span class="token operator">&lt;</span>File<span class="token operator">></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span><span class="token builtin">string</span> fileName<span class="token punctuation">,</span> <span class="token builtin">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token function">nameof</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> blobName <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"N"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> file <span class="token operator">=</span> await FileRepository<span class="token punctuation">.</span><span class="token function">InsertAsync</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token function">File</span><span class="token punctuation">(</span>GuidGenerator<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CurrentTenant<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> blobName<span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        await BlobContainer<span class="token punctuation">.</span><span class="token function">SaveAsync</span><span class="token punctuation">(</span>blobName<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> file<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    public virtual async Task<span class="token operator">&lt;</span><span class="token builtin">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">GetBlobAsync</span><span class="token punctuation">(</span><span class="token builtin">string</span> blobName<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

        Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>blobName<span class="token punctuation">,</span> <span class="token function">nameof</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> await BlobContainer<span class="token punctuation">.</span><span class="token function">GetAllBytesAsync</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<h3 id="应用服"><a href="#应用服" class="headerlink" title="应用服"></a>应用服</h3><p>接下来修改一下应用服务，应用服务通常没有太多业务逻辑，其调用领域服务来完成业务。</p>
<p><strong>应用服务接口</strong></p>
<p>\modules\file-management\src\Xhznl.FileManagement.Application.Contracts\Files\IFileAppService.cs：</p>
<pre class=" language-go"><code class="language-go">public <span class="token keyword">interface</span> IFileAppService <span class="token punctuation">:</span> IApplicationService
<span class="token punctuation">{</span>
    Task<span class="token operator">&lt;</span>FileDto<span class="token operator">></span> <span class="token function">FindByBlobNameAsync</span><span class="token punctuation">(</span><span class="token builtin">string</span> blobName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Task<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span>FileDto input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>应用服务实现</strong></p>
<p>\modules\file-management\src\Xhznl.FileManagement.Application\Files\FileAppService.cs：</p>
<pre class=" language-go"><code class="language-go">public class FileAppService <span class="token punctuation">:</span> FileManagementAppService<span class="token punctuation">,</span> IFileAppService
<span class="token punctuation">{</span>

    protected IFileManager FileManager <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    public <span class="token function">FileAppService</span><span class="token punctuation">(</span>IFileManager fileManager<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        FileManager <span class="token operator">=</span> fileManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public virtual async Task<span class="token operator">&lt;</span>FileDto<span class="token operator">></span> <span class="token function">FindByBlobNameAsync</span><span class="token punctuation">(</span><span class="token builtin">string</span> blobName<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

        Check<span class="token punctuation">.</span><span class="token function">NotNullOrWhiteSpace</span><span class="token punctuation">(</span>blobName<span class="token punctuation">,</span> <span class="token function">nameof</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> file <span class="token operator">=</span> await FileManager<span class="token punctuation">.</span><span class="token function">FindByBlobNameAsync</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> bytes <span class="token operator">=</span> await FileManager<span class="token punctuation">.</span><span class="token function">GetBlobAsync</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token builtin">new</span> FileDto
        <span class="token punctuation">{</span>
            Bytes <span class="token operator">=</span> bytes<span class="token punctuation">,</span>
            FileName <span class="token operator">=</span> file<span class="token punctuation">.</span>FileName
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span>Authorize<span class="token punctuation">]</span>
    public virtual async Task<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span>FileDto input<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        await <span class="token function">CheckFile</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> file <span class="token operator">=</span> await FileManager<span class="token punctuation">.</span><span class="token function">CreateAsync</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>FileName<span class="token punctuation">,</span> input<span class="token punctuation">.</span>Bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> file<span class="token punctuation">.</span>BlobName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    protected virtual async Task <span class="token function">CheckFile</span><span class="token punctuation">(</span>FileDto input<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>Bytes<span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            throw <span class="token builtin">new</span> <span class="token function">AbpValidationException</span><span class="token punctuation">(</span><span class="token string">"Bytes can not be null or empty!"</span><span class="token punctuation">,</span>
                <span class="token builtin">new</span> List<span class="token operator">&lt;</span>ValidationResult<span class="token operator">></span>
                <span class="token punctuation">{</span>
                    <span class="token builtin">new</span> <span class="token function">ValidationResult</span><span class="token punctuation">(</span><span class="token string">"Bytes can not be null or empty!"</span><span class="token punctuation">,</span> <span class="token builtin">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"Bytes"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> allowedMaxFileSize <span class="token operator">=</span> await SettingProvider<span class="token punctuation">.</span>GetAsync<span class="token operator">&lt;</span><span class="token builtin">int</span><span class="token operator">></span><span class="token punctuation">(</span>FileManagementSettings<span class="token punctuation">.</span>AllowedMaxFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//kb</span>

        <span class="token keyword">var</span> allowedUploadFormats <span class="token operator">=</span> <span class="token punctuation">(</span>await SettingProvider<span class="token punctuation">.</span><span class="token function">GetOrNullAsync</span><span class="token punctuation">(</span>FileManagementSettings<span class="token punctuation">.</span>AllowedUploadFormats<span class="token punctuation">)</span><span class="token punctuation">)</span>

            ?<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> StringSplitOptions<span class="token punctuation">.</span>RemoveEmptyEntries<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span>Bytes<span class="token punctuation">.</span>Length <span class="token operator">></span> allowedMaxFileSize <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            throw <span class="token builtin">new</span> <span class="token function">UserFriendlyException</span><span class="token punctuation">(</span>L<span class="token punctuation">[</span><span class="token string">"FileManagement.ExceedsTheMaximumSize"</span><span class="token punctuation">,</span> allowedMaxFileSize<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>allowedUploadFormats <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>allowedUploadFormats<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">GetExtension</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>FileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            throw <span class="token builtin">new</span> <span class="token function">UserFriendlyException</span><span class="token punctuation">(</span>L<span class="token punctuation">[</span><span class="token string">"FileManagement.NotValidFormat"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>API控制器</strong></p>
<p>最后记得将服务接口暴露出去，我这里是自己编写Controller，你也可以使用ABP的自动API控制器来完成，请参考 自动API控制器[2]</p>
<p>\modules\file-management\src\Xhznl.FileManagement.HttpApi\Files\FileController.cs：</p>
<pre class=" language-go"><code class="language-go"><span class="token punctuation">[</span>RemoteService<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"api/file-management/files"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
public class FileController <span class="token punctuation">:</span> FileManagementController
<span class="token punctuation">{</span>
    protected IFileAppService FileAppService <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    public <span class="token function">FileController</span><span class="token punctuation">(</span>IFileAppService fileAppService<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        FileAppService <span class="token operator">=</span> fileAppService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"{blobName}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    public virtual async Task<span class="token operator">&lt;</span>FileResult<span class="token operator">></span> <span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token builtin">string</span> blobName<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> fileDto <span class="token operator">=</span> await FileAppService<span class="token punctuation">.</span><span class="token function">FindByBlobNameAsync</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">File</span><span class="token punctuation">(</span>fileDto<span class="token punctuation">.</span>Bytes<span class="token punctuation">,</span> MimeTypes<span class="token punctuation">.</span><span class="token function">GetByExtension</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">GetExtension</span><span class="token punctuation">(</span>fileDto<span class="token punctuation">.</span>FileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"upload"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span>Authorize<span class="token punctuation">]</span>
    public virtual async Task<span class="token operator">&lt;</span>JsonResult<span class="token operator">></span> <span class="token function">CreateAsync</span><span class="token punctuation">(</span>IFormFile file<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> null<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            throw <span class="token builtin">new</span> <span class="token function">UserFriendlyException</span><span class="token punctuation">(</span><span class="token string">"No file found!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> bytes <span class="token operator">=</span> await file<span class="token punctuation">.</span><span class="token function">GetAllBytesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> result <span class="token operator">=</span> await FileAppService<span class="token punctuation">.</span><span class="token function">CreateAsync</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token function">FileDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Bytes <span class="token operator">=</span> bytes<span class="token punctuation">,</span>
            FileName <span class="token operator">=</span> file<span class="token punctuation">.</span>FileName
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Json</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="单元测试-1"><a href="#单元测试-1" class="headerlink" title="单元测试"></a>单元测试</h3><p>针对以上内容做一个简单的测试，首先为Blob系统配置一个提供程序。</p>
<p>我这里使用最简单的文件系统来储存，所以需要安装<code>Volo.Abp.BlobStoring.FileSystem</code>。在Application.Tests项目目录下执行：<code>abp add-package Volo.Abp.BlobStoring.FileSystem</code></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszS1NGQXI4eWNFOTU2WmVxeU5leHhIZ3ZoYXFWTGxQcDRocVlpY252YTM1azQ3czlCWXBiY1oxQ2Y4S3J1endJeHhZaGd1WDZpYms4YW93LzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p><strong>配置默认容器</strong></p>
<p>\modules\file-management\test\Xhznl.FileManagement.Application.Tests\FileManagementApplicationTestModule.cs：</p>
<pre class=" language-go"><code class="language-go"><span class="token punctuation">[</span><span class="token function">DependsOn</span><span class="token punctuation">(</span>
    <span class="token function">typeof</span><span class="token punctuation">(</span>FileManagementApplicationModule<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">typeof</span><span class="token punctuation">(</span>FileManagementDomainTestModule<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">typeof</span><span class="token punctuation">(</span>AbpBlobStoringFileSystemModule<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">]</span>

public class FileManagementApplicationTestModule <span class="token punctuation">:</span> AbpModule
<span class="token punctuation">{</span>
    public override void <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>ServiceConfigurationContext context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Configure<span class="token operator">&lt;</span>AbpBlobStoringOptions<span class="token operator">></span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            options<span class="token punctuation">.</span>Containers<span class="token punctuation">.</span><span class="token function">ConfigureDefault</span><span class="token punctuation">(</span>container <span class="token operator">=</span><span class="token operator">></span>
            <span class="token punctuation">{</span>
                container<span class="token punctuation">.</span><span class="token function">UseFileSystem</span><span class="token punctuation">(</span>fileSystem <span class="token operator">=</span><span class="token operator">></span>
                <span class="token punctuation">{</span>
                    fileSystem<span class="token punctuation">.</span>BasePath <span class="token operator">=</span> <span class="token string">"D:\\my-files"</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        base<span class="token punctuation">.</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>测试用例</strong></p>
<p>\modules\file-management\test\Xhznl.FileManagement.Application.Tests\Files\FileAppService_Tests.cs：</p>
<pre class=" language-go"><code class="language-go">public class FileAppService_Tests <span class="token punctuation">:</span> FileManagementApplicationTestBase
<span class="token punctuation">{</span>
    private readonly IFileAppService _fileAppService<span class="token punctuation">;</span>
    public <span class="token function">FileAppService_Tests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _fileAppService <span class="token operator">=</span> GetRequiredService<span class="token operator">&lt;</span>IFileAppService<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">[</span>Fact<span class="token punctuation">]</span>
    public async Task <span class="token function">Create_FindByBlobName_Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> blobName <span class="token operator">=</span> await _fileAppService<span class="token punctuation">.</span><span class="token function">CreateAsync</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token function">FileDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            FileName <span class="token operator">=</span> <span class="token string">"微信图片_20200813165555.jpg"</span><span class="token punctuation">,</span>
            Bytes <span class="token operator">=</span> await System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>File<span class="token punctuation">.</span><span class="token function">ReadAllBytesAsync</span><span class="token punctuation">(</span>@<span class="token string">"D:\WorkSpace\WorkFiles\杂项\图片\微信图片_20200813165555.jpg"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blobName<span class="token punctuation">.</span><span class="token function">ShouldNotBeEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> fileDto <span class="token operator">=</span> await _fileAppService<span class="token punctuation">.</span><span class="token function">FindByBlobNameAsync</span><span class="token punctuation">(</span>blobName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileDto<span class="token punctuation">.</span><span class="token function">ShouldNotBeNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileDto<span class="token punctuation">.</span>FileName<span class="token punctuation">.</span><span class="token function">ShouldBe</span><span class="token punctuation">(</span><span class="token string">"微信图片_20200813165555.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>运行测试</strong></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszS1NGQXI4eWNFOTU2WmVxeU5leHhIZ0N2NnpMdVdwY0MxdkFWVjJtZHRxV0llTmliTEc2SnR2T2JpY2ZnbmJNOGZ1WDAxd1hNTWU1M3Z3LzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>测试通过，blob也已经存入D:\my-files：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszS1NGQXI4eWNFOTU2WmVxeU5leHhIZzJqOUNJQndtc2c0N2lhd0pDTnJudlpLUFdLN3JuVVJzZ1VWdXl6RlRyeGtPcFNwaWJpYVNielBwZy82NDA?x-oss-process=image/format,png" alt="img"></p>
<h3 id="模块引用"><a href="#模块引用" class="headerlink" title="模块引用"></a>模块引用</h3><p>下面回到主项目，前面的章节中已经介绍过，模块的引用依赖都已经添加完成，下面就直接从数据库迁移开始。</p>
<p>\src\Xhznl.HelloAbp.EntityFrameworkCore.DbMigrations\EntityFrameworkCore\HelloAbpMigrationsDbContext.cs：</p>
<pre class=" language-go"><code class="language-go">public class HelloAbpMigrationsDbContext <span class="token punctuation">:</span> AbpDbContext<span class="token operator">&lt;</span>HelloAbpMigrationsDbContext<span class="token operator">></span>
<span class="token punctuation">{</span>
    public <span class="token function">HelloAbpMigrationsDbContext</span><span class="token punctuation">(</span>DbContextOptions<span class="token operator">&lt;</span>HelloAbpMigrationsDbContext<span class="token operator">></span> options<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token function">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    protected override void <span class="token function">OnModelCreating</span><span class="token punctuation">(</span>ModelBuilder builder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token operator">...</span><span class="token operator">...</span>
        builder<span class="token punctuation">.</span><span class="token function">ConfigureFileManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">...</span><span class="token operator">...</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>打开程序包管理器控制台，执行以下命令：</p>
<pre><code>Add-Migration &quot;Added_FileManagement&quot;
Update-Database
</code></pre>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszS1NGQXI4eWNFOTU2WmVxeU5leHhIZ3M4SW1STGNGOXo5N0szZGtzQ3dwYzBxc1RVMnRKaWNkcEZaT1pyUnlTaWFYMzhVS3EyVkdMcDdRLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>此时数据库已经生成了File表：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszS1NGQXI4eWNFOTU2WmVxeU5leHhIZ2IwVmNSZ3FDbXBZaWJjQ0s5Tmt0cUVBckd3ZGZyeUNIOTdpY0Z5dUVnemRVanEwY2xEVWZadzlnLzY0MA?x-oss-process=image/format,png" alt="img"></p>
<p>还有记得在HttpApi.Host项目配置你想要的blob提供程序。</p>
<p>最后结合前端测试一下吧：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszS1NGQXI4eWNFOTU2WmVxeU5leHhIZ0hsOEZpY2lhQnRjb3RJc3ZMVXpENGhGbHhJUEtWY1NmTFdVT3pWb3ppY2FEUDlpYXFqQW9XaWI2aFNRLzY0MA?x-oss-process=image/format,png" alt="img"> <img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9jSko0amU1TmszS1NGQXI4eWNFOTU2WmVxeU5leHhIZ0lycDRBRUN6Y2ljOWlicVlaTlhBOFRSSllaR3g4aWFhR2ZrNkw1NEVxandpYmpDQWxOWHlLTXhONncvNjQw?x-oss-process=image/format,png" alt="img"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">蒋岳生</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://github.com/jiayueshe/jiayueshe.github.io/2021/03/25/abp/2020abp-bo-ke-xue-xi-dotnet-kua-ping-tai/">https://github.com/jiayueshe/jiayueshe.github.io/2021/03/25/abp/2020abp-bo-ke-xue-xi-dotnet-kua-ping-tai/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">蒋岳生</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/abp/">
                                    <span class="chip bg-color">abp</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/03/26/linux/centos-an-zhuang-he.net-huan-jing/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="centos安装使用教程">
                        
                        <span class="card-title">centos安装使用教程</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            centos安装使用教程
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-03-26
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/linux/" class="post-category">
                                    linux
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/centos/">
                        <span class="chip bg-color">centos</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/03/25/kaikeba/men-tu-web1/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="数据结构和算法--前端1">
                        
                        <span class="card-title">数据结构和算法--前端1</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            数据结构和算法--前端1
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-03-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/" class="post-category">
                                    数据结构和算法
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/">
                        <span class="chip bg-color">数据结构和算法</span>
                    </a>
                    
                    <a href="/tags/leetcode/">
                        <span class="chip bg-color">leetcode</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">JiangYuesheng</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">260.6k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/jiayueshe/jiayueshe.github.io" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>
    

        
            <a href="mailto:732767079@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
                <i class="fas fa-envelope-open"></i>
            </a>
            

                <!-- 

 -->

                
                    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=732767079" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 732767079" data-position="top" data-delay="50">
                        <i class="fab fa-qq"></i>
                    </a>
                    
                        <!-- 


 -->

                        
                            <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
                                <i class="fas fa-rss"></i>
                            </a>
                            </div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
